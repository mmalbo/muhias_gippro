{% load static %}
<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>GIPPro - MUHIA</title>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="{% static 'gestion/images/logo.png' %}"/>
    
    <!-- ===================== -->
    <!-- 1. JAVASCRIPT CRÍTICO PRIMERO (sin conflictos) -->
    <!-- ===================== -->
    <script>
    // Polyfill para evitar errores tempranos
    if (!window.jQuery) {
        document.write('<script src="https://code.jquery.com/jquery-3.6.0.min.js"><\/script>');
    }
    </script>
    
    <!-- ===================== -->
    <!-- 2. CSS PRINCIPALES -->
    <!-- ===================== -->
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- TUS ESTILOS PERSONALIZADOS (en orden CORRECTO) -->
    <!-- Primero los que NO dependen de otros -->
    <link rel="stylesheet" href="{% static 'gestion/vendor/line-awesome/dist/line-awesome/css/line-awesome.min.css' %}">
    <link rel="stylesheet" href="{% static 'gestion/vendor/remixicon/fonts/remixicon.css' %}">
    
    <!-- Luego los principales -->
    <link rel="stylesheet" href="{% static 'gestion/css/backend-plugin.min.css' %}">
    <link rel="stylesheet" href="{% static 'gestion/css/backend.css' %}">
    
    <!-- DataTables CSS (si es necesario) -->
    <!-- <link rel="stylesheet" type="text/css" href="{% static 'css/jquery.dataTables.min.css' %}"> -->
    
    <!-- Toastr CSS (si es necesario) -->
    <!-- <link rel="stylesheet" href="{% static 'css/toastr.min.css' %}"> -->
    
    {% block extra_css %}{% endblock %}
    
    <style>
    /* CSS de emergencia para asegurar visualización */
    body {
        min-height: 100vh;
        background-color: #f8f9fa;
    }
    
    .wrapper {
        display: flex;
        min-height: 100vh;
    }
    
    .sidebar {
        width: 250px;
        background: #fff;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    
    .main-content {
        flex: 1;
        padding: 20px;
        background: #f8f9fa;
    }
    
    .navbar {
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    </style>
</head>

<body>
<!-- loader Start -->
<div id="loading">
    <div id="loading-center"></div>
</div>
<!-- loader END -->

<!-- Wrapper Start -->
<div class="wrapper">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        {% include 'base/componentes/sidebar.html' %}
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4" id="navbar">
            {% include 'base/componentes/nav_bar.html' %}
        </nav>
        
        <!-- Page Header -->

        
        <!-- Contenido Principal -->
        <div class="container-fluid">
            {% block contenido %}
                <div class="page-header mb-4" id="pageHeader">
                    {% include 'base/componentes/header.html' %}
                </div>
            <!-- El contenido específico de cada página irá aquí -->
            {% endblock %}
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer mt-auto py-3 bg-light border-top" id="footer">
    {% include 'base/componentes/footer.html' %}
</footer>

<!-- ===================== -->
<!-- 3. JAVASCRIPT ORDENADO Y CONTROLADO -->
<!-- ===================== -->

<!-- jQuery (solo una vez, ya cargado por polyfill o aquí) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap 5 Bundle (sin jQuery duplicado) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- SweetAlert2 para diálogos bonitos -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ===================== -->
<!-- 4. TUS SCRIPTS PERSONALIZADOS (con protección) -->
<!-- ===================== -->

<!-- Cargar scripts problemáticos de forma CONTROLADA -->
<script>
// Función para cargar scripts dinámicamente con manejo de errores
function loadScript(src, onSuccess, onError) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = function() {
            console.log('Script cargado:', src);
            if (onSuccess) onSuccess();
            resolve();
        };
        script.onerror = function() {
            console.warn('Error cargando script:', src);
            if (onError) onError();
            reject(new Error('Failed to load ' + src));
        };
        document.body.appendChild(script);
    });
}

// Cargar scripts en orden y con protección
$(document).ready(function() {
    console.log('=== INICIANDO CARGA CONTROLADA DE SCRIPTS ===');
    
    // Primero, scripts esenciales que SÍ necesitas
    const essentialScripts = [
        '{% static "gestion/vendor/moment.min.js" %}',
        '{% static "js/toastr.min.js" %}'
    ];
    
    // Luego, scripts opcionales (pueden fallar)
    const optionalScripts = [
        '{% static "gestion/js/backend-bundle.min.js" %}',
        '{% static "gestion/js/app.js" %}',
        '{% static "gestion/js/customizer.js" %}',
        '{% static "js/jquery.dataTables.min.js" %}'
    ];
    
    // Cargar scripts esenciales
    essentialScripts.forEach(src => {
        loadScript(src, 
            () => console.log('Éxito:', src),
            () => console.log('Falló:', src)
        );
    });
    
    // Esperar y cargar opcionales
    setTimeout(() => {
        optionalScripts.forEach(src => {
            loadScript(src, 
                () => console.log('Opcional cargado:', src),
                () => console.log('Opcional falló (OK):', src)
            );
        });
    }, 1000);
    
    // Inicializar componentes básicos
    initBasicComponents();
});

// Función para inicializar componentes sin dependencias problemáticas
function initBasicComponents() {
    console.log('Inicializando componentes básicos...');
    
    // Tooltips de Bootstrap 5
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        try {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        } catch (e) {
            console.warn('Error inicializando tooltip:', e);
        }
    });
    
    // Popovers de Bootstrap 5
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.map(function (popoverTriggerEl) {
        try {
            return new bootstrap.Popover(popoverTriggerEl);
        } catch (e) {
            console.warn('Error inicializando popover:', e);
        }
    });
    
    // Inicializar sidebar toggle
    $('#sidebarCollapse').on('click', function () {
        $('#sidebar').toggleClass('active');
        $('.main-content').toggleClass('active');
    });
    
    // Ocultar loader
    setTimeout(function() {
        $('#loading').fadeOut('slow');
    }, 500);
}
</script>

<!-- ===================== -->
<!-- 5. MANEJO DE ERRORES GLOBAL -->
<!-- ===================== -->
<script>
// Capturar todos los errores y evitar que rompan la aplicación
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.warn('Error capturado (no crítico):', msg, 'en', url, 'línea', lineNo);
    
    // No mostrar alertas al usuario por errores internos
    // return true; // Previene el handler de error por defecto
    
    // Para debugging, puedes descomentar:
    // console.error('Stack trace:', error?.stack);
    
    return false; // Permite que otros handlers vean el error
};

// Manejar errores de promesas no capturadas
window.addEventListener('unhandledrejection', function(event) {
    console.warn('Promesa rechazada no manejada:', event.reason);
    event.preventDefault();
});

// Proteger jQuery
if (window.jQuery) {
    $(document).ajaxError(function(event, jqxhr, settings, thrownError) {
        console.warn('Error AJAX:', settings.url, thrownError);
    });
}
</script>

<!-- ===================== -->
<!-- 6. JAVASCRIPT DE PÁGINAS ESPECÍFICAS -->
<!-- ===================== -->
{% block javascript %}{% endblock %}

</body>
</html>