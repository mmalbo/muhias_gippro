<!-- templates/parametros/crear_parametro.html -->
{% extends 'base/base.html' %}

{% block contenido %}
    <div class="wrapper">
        <div class="content-page">
            <div class="container-fluid">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="mb-0">
                                        <i class="fas fa-flask"></i>
                                        {% if parametro %}Editar{% else %}Crear{% endif %} Par√°metro de Prueba
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <form method="post" id="parametroForm">
                                        {% csrf_token %}
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    {{ form.nombre.label_tag }}
                                                    {{ form.nombre }}
                                                    {% if form.nombre.errors %}
                                                    <div class="text-danger small">{{ form.nombre.errors }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    {{ form.tipo.label_tag }}
                                                    {{ form.tipo }}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Campos condicionales seg√∫n tipo de valor -->
                                        <div id="camposNumericos" class="campos-condicionales">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        {{ form.unidad_medida.label_tag }}
                                                        {{ form.unidad_medida }}
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        {{ form.valor_minimo.label_tag }}
                                                        {{ form.valor_minimo }}
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        {{ form.valor_maximo.label_tag }}
                                                        {{ form.valor_maximo }}
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        {{ form.valor_objetivo.label_tag }}
                                                        {{ form.valor_objetivo }}
                                                    </div>
                                                </div>
                                            </div>                            
                                        </div>

                                        <!-- Campos para Organolepticos -->
                                        <div id="camposOrganolepticos" class="campos-condicionales" style="display: none;">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="alert alert-info mb-3">
                                                        <i class="fas fa-info-circle"></i>
                                                        Los par√°metros organol√©pticos se eval√∫an cualitativamente.
                                                        No requieren valores num√©ricos m√≠nimos, m√°ximos u objetivo.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Campos para Opciones/Cualitativo -->
<div id="camposOpciones" class="campos-condicionales" style="display: none;">
    <div class="row">
        <div class="col-md-12">
            <div class="mb-3">
                {{ form.opciones_predefinidas.label_tag }}
                {{ form.opciones_predefinidas }}
                <small class="form-text text-muted">
                    Ingrese las opciones separadas por comas (ej: "Aceptable, No Aceptable")
                </small>
            </div>
        </div>
    </div>
</div>

                                        <!-- Campos generales -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    {{ form.metodo_ensayo.label_tag }}
                                                    {{ form.metodo_ensayo }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    {{ form.descripcion.label_tag }}
                                                    {{ form.descripcion }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3 form-check">
                                            {{ form.activo }}
                                            {{ form.activo.label_tag }}
                                        </div>
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <a href="{% url 'parametros_lista' %}" class="btn btn-secondary me-md-2">
                                                <i class="fas fa-times"></i> Cancelar
                                            </a>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save"></i> 
                                                {% if parametro %} Actualizar {% else %} Crear {% endif %} Par√°metro
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- <script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoValorSelect = document.getElementById('id_tipo');
    const camposNumericos = document.getElementById('camposNumericos');
    const camposOrganolepticos = document.getElementById('camposOrganolepticos');
    const camposOpciones = document.getElementById('camposOpciones');
    
// Referencias a campos individuales para marcarlos como requeridos/opcionales
    const unidadMedidaInput = document.querySelector('[name="unidad_medida"]');
    const valorMinimoInput = document.querySelector('[name="valor_minimo"]');
    const valorMaximoInput = document.querySelector('[name="valor_maximo"]');
    const valorObjetivoInput = document.querySelector('[name="valor_objetivo"]');

    function toggleCampos() {
        const tipoValor = tipoValorSelect.value ? tipoSelect.value.toLowerCase() : '';
        const esOrganoleptico = tipoValor.includes('organoleptico') || 
                                tipoValor.includes('organol√©ptico') ||
                                tipoValor === 'organolepticos' ||
                                tipoValor === 'organol√©pticos';
        
        // Resetear display de todos los campos condicionales
        camposNumericos.style.display = 'none';
        camposOrganolepticos.style.display = 'none';
        camposOpciones.style.display = 'none';
        
        // Mostrar campos seg√∫n el tipo
       /* if (tipoValor === 'numerico') {
            camposNumericos.style.display = 'block';
        } else if (tipoValor === 'opciones') {
            camposOpciones.style.display = 'block';
        }*/

        if (esOrganoleptico) {
            // Ocultar campos num√©ricos y mostrar panel informativo
            camposOrganolepticos.style.display = 'block';
            camposNumericos.style.display = none;

            // Opcional: Hacer campos num√©ricos no requeridos
            if (unidadMedidaInput) unidadMedidaInput.required = false;
            if (valorMinimoInput) valorMinimoInput.required = false;
            if (valorMaximoInput) valorMaximoInput.required = false;
            if (valorObjetivoInput) valorObjetivoInput.required = false;
            
            // Opcional: Limpiar valores
            if (valorMinimoInput) valorMinimoInput.value = '';
            if (valorMaximoInput) valorMaximoInput.value = '';
            if (valorObjetivoInput) valorObjetivoInput.value = '';
            
        } else if (tipoValor === 'opciones' || tipoValor === 'cualitativo') {
            // Mostrar campo de opciones predefinidas
            camposOpciones.style.display = 'block';
            camposNumericos.style.display = 'none';
            
        } else {
            // Para otros tipos (f√≠sico, qu√≠mico, microbiol√≥gico), mostrar campos num√©ricos
            camposNumericos.style.display = 'block';
            
            // Hacer campos requeridos si es necesario
            if (unidadMedidaInput) unidadMedidaInput.required = true;
            if (valorMinimoInput) valorMinimoInput.required = true;
            if (valorMaximoInput) valorMaximoInput.required = true;
        }
    }
    

    // Validaci√≥n antes de enviar el formulario
    document.getElementById('parametroForm').addEventListener('submit', function(e) {
        const tipoValor = tipoSelect.value ? tipoSelect.value.toLowerCase() : '';
        const esOrganoleptico = tipoValor.includes('organoleptico') || 
                                tipoValor.includes('organol√©ptico') ||
                                tipoValor === 'organolepticos' ||
                                tipoValor === 'organol√©pticos';
        
        if (!esOrganoleptico) {
            // Para tipos no organol√©pticos, validar campos num√©ricos
            if (valorMinimoInput && valorMaximoInput) {
                const min = parseFloat(valorMinimoInput.value);
                const max = parseFloat(valorMaximoInput.value);
                
                if (!isNaN(min) && !isNaN(max) && min > max) {
                    e.preventDefault();
                    alert('El valor m√≠nimo no puede ser mayor que el valor m√°ximo.');
                    valorMinimoInput.focus();
                    return false;
                }
            }
        }
        
        return true;
    });
    
    // Ejecutar al cargar y cuando cambie el select
    toggleCampos();
    tipoSelect.addEventListener('change', toggleCampos);

    // Tambi√©n ejecutar cuando se cargue la p√°gina (para edici√≥n)
    setTimeout(toggleCampos, 100);
});
</script> -->

<script> 
$(document).ready(function() {
    console.log('‚úÖ Documento listo - Inicializando...');
    
    // Variables
    let contadorParametros = 0;
    const $btnAgregar = $('#btnAgregarParametro');
    const $container = $('#parametrosContainer');
    const $sinParametros = $('#sinParametros');
    const $form = $('#pruebaForm');
    
    // Funci√≥n para mostrar/ocultar campos seg√∫n el tipo de par√°metro
    function actualizarCamposSegunTipo($parametroDiv) {
        const $select = $parametroDiv.find('.parametro-select');
        const tipo = $select.find('option:selected').data('tipo');
        const $valorContainer = $parametroDiv.find('.col-md-3').first();
        const $cumplimientoContainer = $parametroDiv.find('.cumplimiento-container');
        const $valorLabel = $parametroDiv.find('.valor-label');
        const $valorInput = $parametroDiv.find('.valor-input');
        const $cumplimientoCheck = $parametroDiv.find('.cumplimiento-check');
        const $cumplimientoHidden = $parametroDiv.find('.cumplimiento-hidden');
        
        if (tipo === 'organoleptico') {
            // Para organol√©pticos: mostrar checkbox, ocultar valor medido
            $cumplimientoContainer.show();
            $valorContainer.hide();
            $valorInput.removeAttr('required');
            $valorInput.val('N/A'); // Valor por defecto para organol√©pticos
            $cumplimientoHidden.val('false'); // Resetear a falso
            $cumplimientoCheck.prop('checked', false);
        } else {
            // Para otros tipos: mostrar valor medido, ocultar checkbox
            $cumplimientoContainer.hide();
            $valorContainer.show();
            $valorInput.attr('required', 'required');
            $valorLabel.text('Valor Medido *');
            $valorInput.val(''); // Limpiar valor
        }
    }
    
    // Evento para agregar par√°metro
    $btnAgregar.on('click', function() {
        console.log('üîÑ Agregando par√°metro...');
        agregarParametro();
    });
    
    // Funci√≥n para agregar par√°metro
    function agregarParametro() {
        try {
            const template = document.getElementById('parametroTemplate');
            if (!template) {
                throw new Error('Template no encontrado');
            }
            
            contadorParametros++;
            console.log(`‚ûï Creando par√°metro #${contadorParametros}`);
            
            // Clonar template
            const clone = template.content.cloneNode(true);
            const $parametroDiv = $(clone).find('.parametro-item');
            
            // Configurar nombres √∫nicos para cada campo
            configurarNombresCampos($parametroDiv, contadorParametros);
            
            // Configurar eventos
            configurarEventosParametro($parametroDiv);
            
            // Agregar al contenedor
            $container.append($parametroDiv);
            
            // Ocultar mensaje "sin par√°metros"
            $sinParametros.hide();
            
            console.log(`‚úÖ Par√°metro #${contadorParametros} agregado exitosamente`);
            
        } catch (error) {
            console.error('‚ùå Error al agregar par√°metro:', error);
            alert('Error al agregar par√°metro: ' + error.message);
        }
    }
    
    // Configurar nombres √∫nicos para los campos
    function configurarNombresCampos($parametroDiv, index) {
        // IMPORTANTE: Estos nombres deben coincidir con lo que busca la vista
        $parametroDiv.find('.parametro-select').attr('name', `parametro_${index}`);
        $parametroDiv.find('.valor-input').attr('name', `valor_medido_${index}`);
        // NO necesitas campo separado para cumplimiento, se manejar√° en el valor_medido
    }
    
    // Configurar eventos del par√°metro
    function configurarEventosParametro($parametroDiv) {
        // Bot√≥n eliminar
        $parametroDiv.find('.btn-eliminar').on('click', function() {
            const $item = $(this).closest('.parametro-item');
            const index = $item.index() + 1;
            console.log(`üóëÔ∏è Eliminando par√°metro #${index}`);
            $item.remove();
            contadorParametros--;
            renumerarParametros();
            verificarParametrosVacios();
        });
        
        // Actualizar cuando cambia el par√°metro seleccionado
        $parametroDiv.find('.parametro-select').on('change', function() {
            // Actualizar unidad de medida
            const unidad = $(this).find('option:selected').data('unidad') || '';
            $(this).closest('.parametro-item').find('.unidad-text').text(unidad ? `Unidad: ${unidad}` : '');
            
            // Actualizar campos seg√∫n tipo
            actualizarCamposSegunTipo($(this).closest('.parametro-item'));
        });
        
        // Manejar cambios en el checkbox de cumplimiento
        $parametroDiv.find('.cumplimiento-check').on('change', function() {
            const isChecked = $(this).is(':checked');
            // Actualizar el campo de valor medido con el valor booleano
            const $valorInput = $(this).closest('.parametro-item').find('.valor-input');
            $valorInput.val(isChecked ? 'true' : 'false');
            console.log(`Cumplimiento actualizado: ${isChecked ? 'true' : 'false'}`);
        });
    }
    
    // Renumerar par√°metros despu√©s de eliminar
    function renumerarParametros() {
        console.log('üîÑ Renumerando par√°metros...');
        
        $container.find('.parametro-item').each(function(index) {
            const nuevoIndex = index + 1;
            configurarNombresCampos($(this), nuevoIndex);
        });
        
        contadorParametros = $container.children().length;
        console.log(`‚úÖ Renumerado. Total: ${contadorParametros}`);
    }
    
    // Verificar si hay par√°metros
    function verificarParametrosVacios() {
        if ($container.children().length === 0) {
            $sinParametros.show();
            console.log('üì≠ No hay par√°metros');
        } else {
            console.log(`üìä Par√°metros actuales: ${contadorParametros}`);
        }
    }
    
    // Validar formulario antes de enviar
    $form.on('submit', function(e) {
        console.log('üì§ Validando formulario antes de enviar...');
        
        // Verificar que haya al menos un par√°metro
        if (contadorParametros === 0) {
            e.preventDefault();
            alert('‚ùå Debe agregar al menos un par√°metro para la prueba.');
            $btnAgregar.focus();
            return false;
        }
        
        // Verificar que todos los par√°metros tengan valores v√°lidos
        let parametrosCompletos = true;
        let mensajesError = [];
        
        $container.find('.parametro-item').each(function(index) {
            const $select = $(this).find('.parametro-select');
            const $valor = $(this).find('.valor-input');
            const $cumplimientoContainer = $(this).find('.cumplimiento-container');
            const tipo = $select.find('option:selected').data('tipo');
            
            // Validar selecci√≥n de par√°metro
            if (!$select.val()) {
                parametrosCompletos = false;
                mensajesError.push(`Par√°metro ${index + 1}: Seleccione un par√°metro`);
                $select.addClass('is-invalid');
            } else {
                // Validar seg√∫n el tipo de par√°metro
                if (tipo === 'organoleptico') {
                    // Para organol√©pticos, el valor ser√° 'true' o 'false'
                    const valorActual = $valor.val();
                    if (valorActual !== 'true' && valorActual !== 'false') {
                        parametrosCompletos = false;
                        mensajesError.push(`Par√°metro ${index + 1} (organol√©ptico): Marque si cumple o no`);
                        $valor.addClass('is-invalid');
                    }
                } else {
                    // Para otros tipos, verificar valor medido
                    if (!$valor.val().trim()) {
                        parametrosCompletos = false;
                        mensajesError.push(`Par√°metro ${index + 1}: Ingrese un valor medido`);
                        $valor.addClass('is-invalid');
                    }
                }
            }
        });
        
        if (!parametrosCompletos) {
            e.preventDefault();
            alert('‚ùå Complete todos los campos requeridos:\n\n' + mensajesError.join('\n'));
            return false;
        }
        
        // Validar fecha de prueba
        const fechaPrueba = $('#fecha_prueba').val();
        if (!fechaPrueba) {
            e.preventDefault();
            alert('‚ùå Ingrese la fecha de la prueba.');
            $('#fecha_prueba').focus();
            return false;
        }
        
        console.log('‚úÖ Formulario v√°lido, enviando...');
        
        // Mostrar datos que se enviar√°n (para debug)
        console.log('üìã Datos a enviar:');
        const formData = new FormData(this);
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
        
        return true;
    });
    
    // Eliminar clase de error al cambiar
    $(document).on('change', '.parametro-select, .valor-input, .cumplimiento-check', function() {
        $(this).removeClass('is-invalid');
    });
    
    // Agregar primer par√°metro autom√°ticamente
    setTimeout(function() {
        console.log('üöÄ Agregando primer par√°metro autom√°ticamente...');
        agregarParametro();
    }, 500);
    
    console.log('üéâ Configuraci√≥n completada');
});
</script>

<style>
.campos-condicionales {
    border-left: 4px solid #007bff;
    padding-left: 15px;
    margin: 15px 0;
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
}
</style>
{% endblock %}
