{% extends "base/base.html" %}
<!-- Cambia a tu base minimalista -->
{% load static %}

{% block contenido %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-flask me-2"></i>
                Nueva Prueba Qu√≠mica
            </h4>
        </div>
        
        <div class="card-body">
            <!-- Informaci√≥n de producci√≥n -->
            <div class="alert alert-info">
                <h5>Producci√≥n: {{ produccion.lote }}</h5>
                <p class="mb-0">Producto: {{ produccion.catalogo_producto.nombre_comercial }}</p>
            </div>
            
            <!-- Formulario -->
            <form method="post" id="pruebaForm">
                {% csrf_token %}
                
                <!-- Fecha -->
                <div class="mb-3">
                    <label for="fecha_prueba" class="form-label">Fecha de Prueba *</label>
                    <input type="date" class="form-control" id="fecha_prueba" name="fecha_prueba" 
                           value="{% now 'Y-m-d' %}" required>
                </div>
                
                <!-- Fecha vencimiento (opcional) -->
                <div class="mb-3">
                    <label for="fecha_vencimiento" class="form-label">Fecha de Vencimiento (opcional)</label>
                    <input type="date" class="form-control" id="fecha_vencimiento" name="fecha_vencimiento">
                </div>
                
                <!-- Par√°metros -->
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Par√°metros de Prueba</h5>
                        <button type="button" class="btn btn-sm btn-primary" id="btnAgregarParametro">
                            <i class="fas fa-plus me-1"></i> Agregar Par√°metro
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="parametrosContainer">
                            <!-- Los par√°metros aparecer√°n aqu√≠ -->
                        </div>
                        
                        <div id="sinParametros" class="text-center text-muted py-4">
                            <i class="fas fa-flask fa-3x mb-3"></i>
                            <p class="mb-1">No hay par√°metros agregados</p>
                            <small>Haga clic en "Agregar Par√°metro" para comenzar</small>
                        </div>
                    </div>
                </div>
                
                <!-- Observaciones -->
                <div class="mb-3">
                    <label for="observaciones" class="form-label">Observaciones Generales</label>
                    <textarea class="form-control" id="observaciones" name="observaciones" rows="3" 
                              placeholder="Observaciones sobre la prueba..."></textarea>
                </div>
                
                <!-- Botones -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'produccion_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i> Guardar Prueba
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Template para par√°metro - VERSI√ìN SIMPLIFICADA -->
<template id="parametroTemplate">
    <div class="card mb-3 parametro-item" data-index="0">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Par√°metro *</label>
                        <select class="form-control parametro-select" required>
                            <option value="">Seleccionar par√°metro...</option>
                            {% for parametro in parametros_existentes %}
                            <option value="{{ parametro.id }}" 
                                    data-min="{{ parametro.valor_minimo|default:'' }}"
                                    data-max="{{ parametro.valor_maximo|default:'' }}"
                                    data-unidad="{{ parametro.unidad_medida|default:'' }}"
                                    data-tipo="{{ parametro.tipo }}">
                                {{ parametro.nombre }}
                                {% if parametro.unidad_medida %}({{ parametro.unidad_medida }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-3 valor-container">
                    <div class="mb-3">
                        <label class="form-label valor-label">Valor Medido *</label>
                        <input type="text" class="form-control valor-input" placeholder="Valor" required>
                        <small class="form-text text-muted unidad-text"></small>
                    </div>
                </div>
                <!-- Campo de cumplimiento para organol√©pticos -->
                <div class="col-md-3 cumplimiento-container" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">Cumplimiento</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input cumplimiento-check" value="true">
                            <label class="form-check-label">
                                Cumple con el par√°metro
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm btn-eliminar">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block javascript %}
<script>
// JavaScript SIMPLIFICADO y CORREGIDO

document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Documento listo - Inicializando...');
    
    // Variables
    let contadorParametros = 0;
    const btnAgregar = document.getElementById('btnAgregarParametro');
    const container = document.getElementById('parametrosContainer');
    const sinParametros = document.getElementById('sinParametros');
    const form = document.getElementById('pruebaForm');
    const template = document.getElementById('parametroTemplate');
    
    // Funci√≥n para mostrar/ocultar campos seg√∫n el tipo de par√°metro
    function actualizarCamposSegunTipo(parametroItem) {
        const select = parametroItem.querySelector('.parametro-select');
        const selectedOption = select.options[select.selectedIndex];
        const tipo = selectedOption ? selectedOption.getAttribute('data-tipo') : null;
        
        const valorContainer = parametroItem.querySelector('.valor-container');
        const cumplimientoContainer = parametroItem.querySelector('.cumplimiento-container');
        const valorInput = parametroItem.querySelector('.valor-input');
        const unidadText = parametroItem.querySelector('.unidad-text');
        const cumplimientoCheck = parametroItem.querySelector('.cumplimiento-check');
        
        // Obtener unidad de medida
        const unidad = selectedOption ? selectedOption.getAttribute('data-unidad') : '';
        if (unidadText) {
            unidadText.textContent = unidad ? `Unidad: ${unidad}` : '';
        }
        
        if (tipo === 'organoleptico') {
            // Para organol√©pticos: mostrar checkbox, ocultar valor medido
            if (valorContainer) valorContainer.style.display = 'none';
            if (cumplimientoContainer) cumplimientoContainer.style.display = 'block';
            if (valorInput) {
                valorInput.removeAttribute('required');
                valorInput.value = cumplimientoCheck && cumplimientoCheck.checked ? 'true' : 'false';
            }
        } else {
            // Para otros tipos: mostrar valor medido, ocultar checkbox
            if (valorContainer) valorContainer.style.display = 'block';
            if (cumplimientoContainer) cumplimientoContainer.style.display = 'none';
            if (valorInput) {
                valorInput.setAttribute('required', 'required');
                valorInput.value = '';
            }
        }
    }
    
    // Funci√≥n para agregar par√°metro
    function agregarParametro() {
        try {
            if (!template) {
                throw new Error('Template no encontrado');
            }
            
            contadorParametros++;
            console.log(`‚ûï Creando par√°metro #${contadorParametros}`);
            
            // Clonar template
            const clone = document.importNode(template.content, true);
            const parametroItem = clone.querySelector('.parametro-item');
            
            // Configurar nombres √∫nicos para cada campo
            configurarNombresCampos(parametroItem, contadorParametros);
            
            // Configurar eventos
            configurarEventosParametro(parametroItem);
            
            // Agregar al contenedor
            container.appendChild(parametroItem);
            
            // Ocultar mensaje "sin par√°metros"
            sinParametros.style.display = 'none';
            
            console.log(`‚úÖ Par√°metro #${contadorParametros} agregado exitosamente`);
            
        } catch (error) {
            console.error('‚ùå Error al agregar par√°metro:', error);
            alert('Error al agregar par√°metro: ' + error.message);
        }
    }
    
    // Configurar nombres √∫nicos para los campos
    function configurarNombresCampos(parametroItem, index) {
        const select = parametroItem.querySelector('.parametro-select');
        const valorInput = parametroItem.querySelector('.valor-input');
        
        if (select) {
            select.setAttribute('name', `parametro_${index}`);
            select.setAttribute('id', `parametro_${index}`);
        }
        
        if (valorInput) {
            valorInput.setAttribute('name', `valor_medido_${index}`);
            valorInput.setAttribute('id', `valor_medido_${index}`);
        }
    }
    
    // Configurar eventos del par√°metro
    function configurarEventosParametro(parametroItem) {
        // Bot√≥n eliminar
        const btnEliminar = parametroItem.querySelector('.btn-eliminar');
        if (btnEliminar) {
            btnEliminar.addEventListener('click', function() {
                console.log(`üóëÔ∏è Eliminando par√°metro`);
                parametroItem.remove();
                contadorParametros--;
                renumerarParametros();
                verificarParametrosVacios();
            });
        }
        
        // Cambio en el select de par√°metro
        const select = parametroItem.querySelector('.parametro-select');
        if (select) {
            select.addEventListener('change', function() {
                actualizarCamposSegunTipo(parametroItem);
            });
        }
        
        // Cambio en el checkbox de cumplimiento
        const checkbox = parametroItem.querySelector('.cumplimiento-check');
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                const valorInput = parametroItem.querySelector('.valor-input');
                if (valorInput) {
                    valorInput.value = this.checked ? 'true' : 'false';
                }
            });
        }
    }
    
    // Renumerar par√°metros despu√©s de eliminar
    function renumerarParametros() {
        console.log('üîÑ Renumerando par√°metros...');
        
        const items = container.querySelectorAll('.parametro-item');
        items.forEach(function(item, index) {
            const nuevoIndex = index + 1;
            configurarNombresCampos(item, nuevoIndex);
        });
        
        contadorParametros = items.length;
        console.log(`‚úÖ Renumerado. Total: ${contadorParametros}`);
    }
    
    // Verificar si hay par√°metros
    function verificarParametrosVacios() {
        if (container.children.length === 0) {
            sinParametros.style.display = 'block';
            console.log('üì≠ No hay par√°metros');
        } else {
            console.log(`üìä Par√°metros actuales: ${contadorParametros}`);
        }
    }
    
    // Validar formulario antes de enviar
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('üì§ Validando formulario antes de enviar...');
            
            // Verificar que haya al menos un par√°metro
            if (contadorParametros === 0) {
                e.preventDefault();
                alert('‚ùå Debe agregar al menos un par√°metro para la prueba.');
                if (btnAgregar) btnAgregar.focus();
                return false;
            }
            
            // Verificar que todos los par√°metros tengan valores v√°lidos
            let parametrosCompletos = true;
            let mensajesError = [];
            
            const parametrosItems = container.querySelectorAll('.parametro-item');
            
            parametrosItems.forEach(function(item, index) {
                const select = item.querySelector('.parametro-select');
                const valorInput = item.querySelector('.valor-input');
                
                if (!select || !select.value) {
                    parametrosCompletos = false;
                    mensajesError.push(`Par√°metro ${index + 1}: Seleccione un par√°metro`);
                    if (select) select.classList.add('is-invalid');
                } else if (!valorInput || !valorInput.value.trim()) {
                    parametrosCompletos = false;
                    mensajesError.push(`Par√°metro ${index + 1}: Ingrese un valor`);
                    if (valorInput) valorInput.classList.add('is-invalid');
                }
            });
            
            if (!parametrosCompletos) {
                e.preventDefault();
                alert('‚ùå Complete todos los campos requeridos:\n\n' + mensajesError.join('\n'));
                return false;
            }
            
            // Validar fecha de prueba
            const fechaPrueba = document.getElementById('fecha_prueba');
            if (!fechaPrueba || !fechaPrueba.value) {
                e.preventDefault();
                alert('‚ùå Ingrese la fecha de la prueba.');
                if (fechaPrueba) fechaPrueba.focus();
                return false;
            }
            
            console.log('‚úÖ Formulario v√°lido, enviando...');
            return true;
        });
    }
    
    // Evento para agregar par√°metro
    if (btnAgregar) {
        btnAgregar.addEventListener('click', agregarParametro);
    }
    
    // Eliminar clase de error al cambiar
    container.addEventListener('change', function(e) {
        if (e.target.classList.contains('parametro-select') || 
            e.target.classList.contains('valor-input')) {
            e.target.classList.remove('is-invalid');
        }
    });
    
    // Agregar primer par√°metro autom√°ticamente
    setTimeout(function() {
        console.log('üöÄ Agregando primer par√°metro autom√°ticamente...');
        agregarParametro();
    }, 500);
    
    console.log('üéâ Configuraci√≥n completada');
});
</script>

<style>
.parametro-item {
    border-left: 4px solid #0d6efd;
    transition: all 0.3s;
}

.parametro-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.btn-eliminar:hover {
    transform: scale(1.1);
}

.is-invalid {
    border-color: #dc3545 !important;
}

.cumplimiento-check:checked {
    background-color: #198754;
    border-color: #198754;
}
</style>
{% endblock %}