{% extends "base/base.html" %}
{% load static %}

{% block contenido %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-title-box">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="page-title mb-0">
                            <i class="fas fa-flask me-2"></i>
                            Prueba Química #{{ prueba.nomenclador_prueba }}
                        </h4>

                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-{{ prueba.estado|lower }} fs-6 p-2" style="color: grey;">
                            <i class="fas fa-{{ prueba.estado|lower }} me-1"></i>
                            {{ prueba.estado|upper }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna izquierda: Información y Acciones -->
        <div class="col-lg-4">
            <!-- Información de la Prueba -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i> Información de la Prueba
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Producción:</dt>
                        <dd class="col-sm-7">
                            <strong>{{ prueba.produccion.lote }}</strong>
                        </dd>
                        
                        <dt class="col-sm-5">Producto:</dt>
                        <dd class="col-sm-7">{{ prueba.produccion.catalogo_producto.nombre_comercial }}</dd>
                        
                        <dt class="col-sm-5">Fecha Prueba:</dt>
                        <dd class="col-sm-7">{{ prueba.fecha_prueba|date:"d/m/Y" }}</dd>
                        
                        <dt class="col-sm-5">Fecha Vencimiento:</dt>
                        <dd class="col-sm-7">
                            {% if prueba.fecha_vencimiento %}
                                {{ prueba.fecha_vencimiento|date:"d/m/Y" }}
                            {% else %}
                                <span class="text-muted">No especificado</span>
                            {% endif %}
                        </dd>
                        
                        {% if prueba.evaluado_por %}
                        <dt class="col-sm-5">Evaluado por:</dt>
                        <dd class="col-sm-7">{{ prueba.evaluado_por.get_full_name|default:prueba.evaluado_por.username }}</dd>
                        
                        <dt class="col-sm-5">Fecha Evaluación:</dt>
                        <dd class="col-sm-7">{{ prueba.fecha_evaluacion|date:"d/m/Y" }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Panel de Acciones -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i> Acciones
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <!-- Botón para agregar parámetros (siempre visible)
                        <button type="button" class="btn btn-primary" id="btnAgregarParametroModal">
                            <i class="fas fa-plus-circle me-2"></i> Agregar Parámetros
                        </button> -->
                        
                        <!-- Botón para concluir prueba (si está pendiente) -->
                        {% if prueba.estado != 'APROBADA' and prueba.estado != 'RECHAZADA' and prueba.estado != 'CANCELADA' %}
                        <a href="{% url 'calcular_resultados_prueba' prueba.id %}" class="btn btn-success">
                            <i class="fas fa-flag-checkered me-2"></i> Concluir Prueba
                        </a>
                        {% endif %}
                        
                        <!-- <button type="button" class="btn btn-success" id="btnConcluirPrueba"></button>
                                Botón para cambiar estado 
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-info dropdown-toggle" 
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-sync-alt me-2"></i> Cambiar Estado
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="cambiarEstado('EN_PROCESO')">
                                    <i class="fas fa-play text-info me-2"></i> En Proceso
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="cambiarEstado('COMPLETADA')">
                                    <i class="fas fa-check text-primary me-2"></i> Completada
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="cambiarEstado('CANCELADA')">
                                    <i class="fas fa-ban me-2"></i> Cancelar
                                </a></li>
                            </ul>
                        </div>-->
                        
                        <!-- Botones adicionales -->
                        <a href="{% url 'produccion_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i> Volver a Listado
                        </a>
                    </div>
                </div>
            </div>            
        </div>

        <!-- Columna derecha: Parámetros -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-check me-2"></i> Parámetros Evaluados
                    </h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-primary me-2" id="btnAgregarParametro">
                            <i class="fas fa-plus me-1"></i> Agregar
                        </button>
                        <span class="badge bg-primary">Total: <span id="contadorTotal">{{ total_parametros }}</span></span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Contenedor para nuevos parámetros (formulario dinámico) -->
                    <div id="nuevosParametrosContainer" class="p-3 border-bottom" style="display: none;">
                        <h6 class="mb-3"><i class="fas fa-plus-circle me-2"></i> Nuevos Parámetros</h6>
                        <form id="formAgregarParametros">
                            <div id="parametrosDinamicos"></div>
                            <div class="d-flex justify-content-between mt-3">
                                <button type="button" class="btn btn-sm btn-outline-success" id="btnAgregarMas">
                                    <i class="fas fa-plus me-1"></i> Agregar Otro
                                </button>
                                <div>
                                    <button type="button" class="btn btn-sm btn-secondary me-2" id="btnCancelarAgregar">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fas fa-save me-1"></i> Guardar Todos
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Tabla de parámetros existentes -->
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="20%">Parámetro</th>
                                    <th width="15%">Valor Medido</th>
                                    <th width="15%">Rango Esperado</th>
                                    <th width="10%">Unidad</th>
                                    <th width="10%">Estado</th>
                                    <th width="25%">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaParametros">
                                {% for parametro in parametros %}
                                <tr id="parametro-{{ parametro.id }}" class="{% if parametro.dentro_especificacion %}table-success{% else %}table-danger{% endif %}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <strong>{{ parametro.parametro.nombre }}</strong>                                       
                                    </td>
                                    <td>
                                        <span class="valor-actual">{{ parametro.valor_medido }}</span>
                                        <input type="text" class="form-control form-control-sm valor-edit d-none" 
                                               value="{{ parametro.valor_medido }}" 
                                               data-id="{{ parametro.id }}">
                                    </td>
                                    <td>
                                        {% if parametro.parametro.valor_minimo and parametro.parametro.valor_maximo %}
                                        {{ parametro.parametro.valor_minimo }} - {{ parametro.parametro.valor_maximo }}
                                        {% elif parametro.parametro.valor_referencia %}
                                        {{ parametro.parametro.valor_referencia }}
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ parametro.parametro.unidad_medida|default:"-" }}</td>
                                    <td>
                                        <span class="badge {% if parametro.cumplimiento %}bg-success{% else %}bg-danger{% endif %} estado-badge">
                                            <i class="fas fa-{% if parametro.cumplimiento %}check{% else %}times{% endif %} me-1"></i>
                                            {% if parametro.cumplimiento %}OK{% else %}Falla{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Editar valor -->
                                            <button type="button" class="btn btn-outline-warning btn-editar" 
                                                    data-id="{{ parametro.id }}"
                                                    data-bs-toggle="tooltip" title="Editar valor">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            
                                            <!-- Guardar cambios (oculto inicialmente) -->
                                            <button type="button" class="btn btn-outline-success btn-guardar d-none" 
                                                    data-id="{{ parametro.id }}"
                                                    data-bs-toggle="tooltip" title="Guardar cambios">
                                                <i class="fas fa-save"></i>
                                            </button>
                                            
                                            <!-- Cancelar edición (oculto inicialmente) -->
                                            <button type="button" class="btn btn-outline-secondary btn-cancelar d-none" 
                                                    data-id="{{ parametro.id }}"
                                                    data-bs-toggle="tooltip" title="Cancelar">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            
                                            <!-- Ver detalles -->
                                            <button type="button" class="btn btn-outline-info" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#modalDetalleParametro"
                                                    data-nombre="{{ parametro.parametro.nombre }}"
                                                    data-valor="{{ parametro.valor_medido }}"
                                                    data-min="{{ parametro.parametro.valor_minimo|default:'' }}"
                                                    data-max="{{ parametro.parametro.valor_maximo|default:'' }}"
                                                    data-unidad="{{ parametro.parametro.unidad_medida|default:'' }}"
                                                    data-estado="{% if parametro.cumplimiento %}OK{% else %}Falla{% endif %}"
                                                    data-observaciones="{{ parametro.observaciones|default:'' }}"
                                                    data-bs-toggle="tooltip" title="Ver detalles">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            
                                            <!-- Eliminar -->
                                            <button type="button" class="btn btn-outline-danger btn-eliminar" 
                                                    data-id="{{ parametro.id }}"
                                                    data-nombre="{{ parametro.parametro.nombre }}"
                                                    data-bs-toggle="tooltip" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr id="sinParametros">
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-flask fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No hay parámetros registrados</h5>
                                        <p class="text-muted mb-0">Agregue parámetros para evaluar esta prueba</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="contadorAprobados">{{ parametros_aprobados }}</span> de 
                                <span id="contadorTotalFooter">{{ total_parametros }}</span> parámetros aprobados
                            </small>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para concluir prueba -->
<div class="modal fade" id="modalConcluirPrueba" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-flag-checkered me-2"></i>
                    Concluir Prueba Química
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="#" id="formConcluirPrueba">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-chart-pie me-2"></i> Resumen de Resultados</h6>
                        <div class="row mt-2">
                            <div class="col-md-4 text-center">
                                <div class="h4" id="modalTotalParametros">{{ total_parametros }}</div>
                                <small class="text-muted">Total Parámetros</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="h4 text-success" id="modalAprobados">{{ parametros_aprobados }}</div>
                                <small class="text-muted">Aprobados</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="h4" id="modalPorcentaje">{{ porcentaje_aprobacion }}%</div>
                                <small class="text-muted">% Aprobación</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="resultadoFinal" class="form-label">Resultado Final</label>
                        <textarea class="form-control" id="resultadoFinal" name="resultado_final" 
                                  rows="4" placeholder="Describa el resultado final de la prueba..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacionesFinal" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observacionesFinal" name="observaciones" 
                                  rows="3" placeholder="Observaciones adicionales..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Decisión Final</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="aprobado" id="aprobadoSi" value="true">
                            <label class="form-check-label text-success" for="aprobadoSi">
                                <i class="fas fa-thumbs-up me-2"></i> Aprobar Prueba
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="aprobado" id="aprobadoNo" value="false">
                            <label class="form-check-label text-danger" for="aprobadoNo">
                                <i class="fas fa-thumbs-down me-2"></i> Rechazar Prueba
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar Conclusión</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para detalles del parámetro -->
<div class="modal fade" id="modalDetalleParametro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-vial me-2"></i>
                    <span id="modalParametroNombre"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-4">Valor Medido:</dt>
                    <dd class="col-sm-8" id="modalParametroValor"></dd>
                    
                    <dt class="col-sm-4">Rango Permitido:</dt>
                    <dd class="col-sm-8" id="modalParametroRango"></dd>
                    
                    <dt class="col-sm-4">Unidad:</dt>
                    <dd class="col-sm-8" id="modalParametroUnidad"></dd>
                    
                    <dt class="col-sm-4">Estado:</dt>
                    <dd class="col-sm-8">
                        <span class="badge" id="modalParametroEstado"></span>
                    </dd>
                    
                    <dt class="col-sm-4">Observaciones:</dt>
                    <dd class="col-sm-8" id="modalParametroObservaciones"></dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Template para nuevos parámetros dinámicos -->
<template id="templateParametroDinamico">
    <div class="parametro-dinamico card mb-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-5">
                    <select class="form-control form-control-sm parametro-select" required>
                        <option value="">Seleccionar parámetro...</option>
                        {% for parametro in parametros_disponibles %}
                        <option value="{{ parametro.id }}" 
                                data-min="{{ parametro.valor_minimo|default:'' }}"
                                data-max="{{ parametro.valor_maximo|default:'' }}"
                                data-unidad="{{ parametro.unidad_medida|default:'' }}">
                            {{ parametro.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm valor-input" 
                           placeholder="Valor medido" required>
                    <small class="form-text text-muted unidad-text"></small>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm observacion-input" 
                           placeholder="Observación">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-danger btn-eliminar-dinamico">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block javascript %}

<script>

function getCSRFToken() {
    return '{{ csrf_token }}';  // Esto funciona si estás en un template
}

    // Guardar cambios (con UUID) - VERSIÓN CORREGIDA
$(document).on('click', '.btn-guardar', function() {
    const $btn = $(this);
    const parametroId = $btn.data('id');  // UUID del parámetro
    const $fila = $(`#parametro-${parametroId}`);
    const nuevoValor = $fila.find('.valor-edit').val().trim();
    
    // Validación básica
    if (!nuevoValor) {
        mostrarMensaje('warning', 'Ingrese un valor para el parámetro');
        $fila.find('.valor-edit').focus();
        return;
    }
    
    // Validar si es un número (para parámetros numéricos)
    const valorNumerico = parseFloat(nuevoValor);
    if (isNaN(valorNumerico) && !/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(nuevoValor)) {
        mostrarMensaje('warning', 'Ingrese un valor válido (numérico o texto)');
        $fila.find('.valor-edit').focus();
        return;
    }
    
    // Preparar datos para enviar
    const formData = new FormData();
    formData.append('valor_medido', nuevoValor);
    formData.append('csrfmiddlewaretoken', getCSRFToken());
    
    // Cambiar estado del botón
    $btn.prop('disabled', true)
        .html('<i class="fas fa-spinner fa-spin me-1"></i>');
    
    console.log('Enviando edición para parámetro ID:', parametroId);
    console.log('Nuevo valor:', nuevoValor);
    console.log('URL:', `/produccion/parametro-prueba/${parametroId}/editar/`);
    
    // Usar fetch en lugar de jQuery.ajax para mayor control
    fetch(`/produccion/parametro-prueba/${parametroId}/editar/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        console.log('Respuesta HTTP recibida, status:', response.status);
        
        // Verificar si la respuesta es JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('La respuesta del servidor no es JSON');
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Respuesta JSON parseada:', data);
        
        if (data.success) {
            // 1. Actualizar valor en la tabla
            $fila.find('.valor-actual').text(nuevoValor);
            
            // 2. Cambiar estilos según cumplimiento
            const esAprobado = data.dentro_especificacion;
            
            if (esAprobado) {
                $fila.removeClass('table-danger').addClass('table-success');
                $fila.find('.estado-badge')
                    .removeClass('bg-danger')
                    .addClass('bg-success')
                    .html('<i class="fas fa-check me-1"></i> OK');
                
                // Actualizar contadores (si cambiaba de rechazado a aprobado)
                if ($fila.hasClass('table-danger')) {
                    contadorAprobados++;
                    contadorRechazados = Math.max(0, contadorRechazados - 1);
                }
            } else {
                $fila.removeClass('table-success').addClass('table-danger');
                $fila.find('.estado-badge')
                    .removeClass('bg-success')
                    .addClass('bg-danger')
                    .html('<i class="fas fa-times me-1"></i> Falla');
                
                // Actualizar contadores (si cambiaba de aprobado a rechazado)
                if ($fila.hasClass('table-success')) {
                    contadorRechazados++;
                    contadorAprobados = Math.max(0, contadorAprobados - 1);
                }
            }
            
            // 3. Actualizar contadores globales
            actualizarContadores();
            
            // 4. Mostrar mensaje de éxito
            mostrarMensaje('success', '¡Valor actualizado correctamente!');
            
            // 5. Restaurar modo visualización
            $fila.find('.valor-actual').removeClass('d-none');
            $fila.find('.valor-edit').addClass('d-none');
            $fila.find('.btn-editar').removeClass('d-none');
            $fila.find('.btn-guardar, .btn-cancelar').addClass('d-none');
            
        } else {
            // Mostrar error del servidor
            mostrarMensaje('error', data.message || 'Error al actualizar el parámetro');
            
            // Mantener en modo edición
            $btn.prop('disabled', false)
                .html('<i class="fas fa-save"></i>');
        }
    })
    .catch(error => {
        console.error('Error en la petición:', error);
        
        // Mostrar error detallado
        let mensajeError = 'Error de conexión con el servidor';
        if (error.message.includes('JSON')) {
            mensajeError = 'El servidor respondió con un formato no válido. Revise la consola.';
        }
        
        mostrarMensaje('error', mensajeError);
        
        // Restaurar botón
        $btn.prop('disabled', false)
            .html('<i class="fas fa-save"></i>');
            
        // Mostrar error en consola para depuración
        console.error('Detalles del error:', error);
    });
});

// También mejora la función para cancelar edición:
$(document).on('click', '.btn-cancelar', function() {
    const parametroId = $(this).data('id');
    const $fila = $(`#parametro-${parametroId}`);
    
    // Restaurar valor original
    const valorOriginal = $fila.find('.valor-actual').text();
    $fila.find('.valor-edit').val(valorOriginal);
    
    // Cambiar a modo visualización
    $fila.find('.valor-edit').addClass('d-none');
    $fila.find('.valor-actual').removeClass('d-none');
    $fila.find('.btn-editar').removeClass('d-none');
    $fila.find('.btn-guardar, .btn-cancelar').addClass('d-none');
});

// Y mejora la función de edición para guardar el valor original:
$(document).on('click', '.btn-editar', function() {
    const parametroId = $(this).data('id');
    const $fila = $(`#parametro-${parametroId}`);
    const valorActual = $fila.find('.valor-actual').text().trim();
    
    // Configurar campo de edición con el valor actual
    $fila.find('.valor-edit').val(valorActual);
    
    // Cambiar a modo edición
    $fila.find('.valor-actual').addClass('d-none');
    $fila.find('.valor-edit').removeClass('d-none').focus();
    $(this).addClass('d-none');
    $fila.find('.btn-guardar, .btn-cancelar').removeClass('d-none');
});

// ============================================
// 4. AGREGAR NUEVOS PARÁMETROS (con UUID de prueba)
// ============================================
$('#btnAgregarParametro, #btnAgregarParametroModal').on('click', function() {
    $('#nuevosParametrosContainer').toggle();
    if ($('#nuevosParametrosContainer').is(':visible')) {
        agregarCampoParametro();
    }
});
    
function agregarCampoParametro() {
    const template = document.getElementById('templateParametroDinamico');
    const clone = template.content.cloneNode(true);
        
    const $clone = $(clone);
        
    // Configurar eventos
    $clone.find('.parametro-select').on('change', function() {
        const unidad = $(this).find('option:selected').data('unidad') || '';
        $(this).closest('.parametro-dinamico').find('.unidad-text').text('Unidad: ' + unidad);
    });
        
    $clone.find('.btn-eliminar-dinamico').on('click', function() {
        $(this).closest('.parametro-dinamico').remove();
    });
        
    $('#parametrosDinamicos').append($clone);
}
    
$('#btnAgregarMas').on('click', agregarCampoParametro);
    
// Guardar nuevos parámetros
$('#formAgregarParametros').on('submit', function(e) {
    e.preventDefault();
        
    const parametrosData = [];
    let valido = true;
        
    // Validar y recopilar datos
    $('.parametro-dinamico').each(function() {
        const $select = $(this).find('.parametro-select');
        const $valor = $(this).find('.valor-input');
        const $observacion = $(this).find('.observacion-input');
        
        if (!$select.val() || !$valor.val().trim()) {
            valido = false;
            $(this).addClass('border-danger');
            return false;
        }
            
        $(this).removeClass('border-danger');
            
        parametrosData.push({
            parametro_id: $select.val(),
            valor_medido: $valor.val().trim(),
            observaciones: $observacion.val().trim(),
            parametro_nombre: $select.find('option:selected').text()
        });
    });
        
    if (!valido) {
        mostrarMensaje('warning', 'Complete todos los campos requeridos (marcados en rojo)');
        return;
    }
        
    if (parametrosData.length === 0) {
        mostrarMensaje('warning', 'Agregue al menos un parámetro');
        return;
    }
        
    // Configurar botón de envío
    const $submitBtn = $('#formAgregarParametros button[type="submit"]');
    $submitBtn.prop('disabled', true)
        .html('<i class="fas fa-spinner fa-spin me-1"></i> Guardando...');
       
    // Enviar datos al servidor
    fetch(URLS.agregarParametros, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            parametros: parametrosData,
            csrfmiddlewaretoken: getCSRFToken()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje('success', data.message || 'Parámetros agregados correctamente');
              
            // Recargar la página después de un breve retraso
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            mostrarMensaje('error', data.message || 'Error al guardar los parámetros');
            $submitBtn.prop('disabled', false)
            .html('<i class="fas fa-save me-1"></i> Guardar Todos');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('error', 'Error de conexión al servidor');
        $submitBtn.prop('disabled', false)
            .html('<i class="fas fa-save me-1"></i> Guardar Todos');
    });
});

</script>
{% endblock %}