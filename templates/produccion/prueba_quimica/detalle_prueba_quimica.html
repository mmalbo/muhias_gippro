{% extends "base/base.html" %}
{% load static %}

{% block contenido %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-title-box">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="page-title mb-0">
                            <i class="fas fa-flask me-2"></i>
                            Prueba Química #{{ prueba.nomenclador_prueba }}
                        </h4>

                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-{{ prueba.estado|lower }} fs-6 p-2" style="color: grey;">
                            <i class="fas fa-{{ prueba.estado|lower }} me-1"></i>
                            {{ prueba.estado|upper }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna izquierda: Información y Acciones -->
        <div class="col-lg-4">
            <!-- Información de la Prueba -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i> Información de la Prueba
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Producción:</dt>
                        <dd class="col-sm-7">
                            <strong>{{ prueba.produccion.lote }}</strong>
                        </dd>
                        
                        <dt class="col-sm-5">Producto:</dt>
                        <dd class="col-sm-7">{{ prueba.produccion.catalogo_producto.nombre_comercial }}</dd>
                        
                        <dt class="col-sm-5">Fecha Prueba:</dt>
                        <dd class="col-sm-7">{{ prueba.fecha_prueba|date:"d/m/Y" }}</dd>
                        
                        <dt class="col-sm-5">Fecha Vencimiento:</dt>
                        <dd class="col-sm-7">
                            {% if prueba.fecha_vencimiento %}
                                {{ prueba.fecha_vencimiento|date:"d/m/Y" }}
                            {% else %}
                                <span class="text-muted">No especificado</span>
                            {% endif %}
                        </dd>
                        
                        {% if prueba.evaluado_por %}
                        <dt class="col-sm-5">Evaluado por:</dt>
                        <dd class="col-sm-7">{{ prueba.evaluado_por.get_full_name|default:prueba.evaluado_por.username }}</dd>
                        
                        <dt class="col-sm-5">Fecha Evaluación:</dt>
                        <dd class="col-sm-7">{{ prueba.fecha_evaluacion|date:"d/m/Y" }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Panel de Acciones -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i> Acciones
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <!-- Botón para agregar parámetros (siempre visible)
                        <button type="button" class="btn btn-primary" id="btnAgregarParametroModal">
                            <i class="fas fa-plus-circle me-2"></i> Agregar Parámetros
                        </button> -->
                        
                        <!-- Botón para concluir prueba (si está pendiente) -->
                        {% if prueba.estado != 'Aprobada' and prueba.estado != 'Rechazada' and prueba.estado != 'Cancelada' %}
                            <button type="button" class="btn btn-success" id="btnConcluirPrueba">
                                <i class="fas fa-flag-checkered me-2"></i> Concluir Prueba
                            </button>
                        {% endif %}
                        
                        <!--<a href="{% url 'calcular_resultados_prueba' prueba.id %}" class="btn btn-success">
                            <i class="fas fa-flag-checkered me-2"></i> Concluir Prueba
                        </a>
                                Botón para cambiar estado 
                            <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-info dropdown-toggle" 
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-sync-alt me-2"></i> Cambiar Estado
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="cambiarEstado('EN_PROCESO')">
                                    <i class="fas fa-play text-info me-2"></i> En Proceso
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="cambiarEstado('COMPLETADA')">
                                    <i class="fas fa-check text-primary me-2"></i> Completada
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="cambiarEstado('CANCELADA')">
                                    <i class="fas fa-ban me-2"></i> Cancelar
                                </a></li>
                            </ul>
                        </div>-->
                        
                        <!-- Botones adicionales -->
                        <a href="{% url 'produccion_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i> Volver a Listado
                        </a>
                    </div>
                </div>
            </div>            
        </div>

        <!-- Columna derecha: Parámetros -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-check me-2"></i> Parámetros Evaluados
                    </h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-primary me-2" id="btnAgregarParametro">
                            <i class="fas fa-plus me-1"></i> Agregar
                        </button>
                        <span class="badge bg-primary">Total: <span id="contadorTotal">{{ total_parametros }}</span></span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Contenedor para nuevos parámetros (formulario dinámico) -->
                    <div id="nuevosParametrosContainer" class="p-3 border-bottom" style="display: none;">
                        <h6 class="mb-3"><i class="fas fa-plus-circle me-2"></i> Nuevos Parámetros</h6>
                        <form id="formAgregarParametros">
                            <div id="parametrosDinamicos"></div>
                            <div class="d-flex justify-content-between mt-3">
                                <button type="button" class="btn btn-sm btn-outline-success" id="btnAgregarMas">
                                    <i class="fas fa-plus me-1"></i> Agregar Otro
                                </button>
                                <div>
                                    <button type="button" class="btn btn-sm btn-secondary me-2" id="btnCancelarAgregar">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fas fa-save me-1"></i> Guardar Todos
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Tabla de parámetros existentes -->
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="20%">Parámetro</th>
                                    <th width="15%">Valor Medido</th>
                                    <th width="15%">Rango Esperado</th>
                                    <th width="10%">Unidad</th>
                                    <th width="10%">Estado</th>
                                    <th width="25%">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaParametros">
                                {% for parametro in parametros %}
                                <tr id="parametro-{{ parametro.id }}" class="{% if parametro.dentro_especificacion %}table-success{% else %}table-danger{% endif %}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <strong>{{ parametro.parametro.nombre }}</strong>                                       
                                    </td>
                                    <td>
                                        <span class="valor-actual">{{ parametro.valor_medido }}</span>
                                        <input type="text" class="form-control form-control-sm valor-edit d-none" 
                                               value="{{ parametro.valor_medido }}" 
                                               data-id="{{ parametro.id }}">
                                    </td>
                                    <td>
                                        {% if parametro.parametro.valor_minimo and parametro.parametro.valor_maximo %}
                                        {{ parametro.parametro.valor_minimo }} - {{ parametro.parametro.valor_maximo }}
                                        {% elif parametro.parametro.valor_referencia %}
                                        {{ parametro.parametro.valor_referencia }}
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ parametro.parametro.unidad_medida|default:"-" }}</td>
                                    <td>
                                        <span class="badge {% if parametro.cumplimiento %}bg-success{% else %}bg-danger{% endif %} estado-badge">
                                            <i class="fas fa-{% if parametro.cumplimiento %}check{% else %}times{% endif %} me-1"></i>
                                            {% if parametro.cumplimiento %}OK{% else %}Falla{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Editar valor -->
                                            <button type="button" class="btn btn-outline-warning btn-editar" 
                                                    data-id="{{ parametro.id }}"
                                                    data-bs-toggle="tooltip" title="Editar valor">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            
                                            <!-- Guardar cambios (oculto inicialmente) -->
                                            <button type="button" class="btn btn-outline-success btn-guardar d-none" 
                                                    data-id="{{ parametro.id }}"
                                                    data-bs-toggle="tooltip" title="Guardar cambios">
                                                <i class="fas fa-save"></i>
                                            </button>
                                            
                                            <!-- Cancelar edición (oculto inicialmente) -->
                                            <button type="button" class="btn btn-outline-secondary btn-cancelar d-none" 
                                                    data-id="{{ parametro.id }}"
                                                    data-bs-toggle="tooltip" title="Cancelar">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            
                                            <!-- Ver detalles -->
                                            <button type="button" class="btn btn-outline-info" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#modalDetalleParametro"
                                                    data-nombre="{{ parametro.parametro.nombre }}"
                                                    data-valor="{{ parametro.valor_medido }}"
                                                    data-min="{{ parametro.parametro.valor_minimo|default:'' }}"
                                                    data-max="{{ parametro.parametro.valor_maximo|default:'' }}"
                                                    data-unidad="{{ parametro.parametro.unidad_medida|default:'' }}"
                                                    data-estado="{% if parametro.cumplimiento %}OK{% else %}Falla{% endif %}"
                                                    data-observaciones="{{ parametro.observaciones|default:'' }}"
                                                    data-bs-toggle="tooltip" title="Ver detalles">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            
                                            <!-- Eliminar -->
                                            <button type="button" class="btn btn-outline-danger btn-eliminar" 
                                                    data-id="{{ parametro.id }}"
                                                    data-nombre="{{ parametro.parametro.nombre }}"
                                                    data-bs-toggle="tooltip" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr id="sinParametros">
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-flask fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No hay parámetros registrados</h5>
                                        <p class="text-muted mb-0">Agregue parámetros para evaluar esta prueba</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="contadorAprobados">{{ parametros_aprobados }}</span> de 
                                <span id="contadorTotalFooter">{{ total_parametros }}</span> parámetros aprobados
                            </small>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para concluir prueba -->
<div class="modal fade" id="modalConcluirPrueba" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-flag-checkered me-2"></i>
                    Concluir Prueba Química - Evaluación Final
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'concluir_prueba_quimica' prueba.pk %}" id="formConcluirPrueba">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Resumen Estadístico -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-chart-pie me-2"></i> Resumen de Resultados</h6>
                        <div class="row mt-2">
                            <div class="col-md-4 text-center">
                                <div class="h4" id="modalTotalParametros">{{ total_parametros }}</div>
                                <small class="text-muted">Total Parámetros</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="h4 text-success" id="modalAprobados">{{ parametros_aprobados }}</div>
                                <small class="text-muted">Aprobados</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="h4" id="modalPorcentaje">{{ porcentaje_aprobacion }}%</div>
                                <small class="text-muted">% Aprobación</small>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de todos los parámetros evaluados -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-list-check me-2"></i>
                                Resumen de Parámetros Evaluados
                                <small class="text-muted ms-2">({{ total_parametros }} registros)</small>
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th width="5%">#</th>
                                            <th width="25%">Parámetro</th>
                                            <th width="15%">Valor Medido</th>
                                            <th width="10%">Estado</th>
                                            <th width="30%">Observaciones/Justificación</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for detalle in parametros %}
                                        <tr class="{% if detalle.cumplimiento %}table-success{% else %}table-danger{% endif %}">
                                            <td>{{ forloop.counter }}</td>
                                            <td>
                                                <strong>{{ detalle.parametro.nombre }}</strong>                                                
                                            </td>
                                            <td>
                                                {{ detalle.valor_medido }}
                                            </td>
                                            <td>
                                                <span class="badge {% if detalle.cumplimiento %}bg-success{% else %}bg-danger{% endif %}">
                                                    <i class="fas fa-{% if detalle.cumplimiento %}check{% else %}times{% endif %} me-1"></i>
                                                    {% if detalle.cumplimiento %}OK{% else %}Falla{% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <textarea class="form-control form-control-sm observacion-final" 
                                                          name="observaciones_{{ detalle.id }}"
                                                          rows="2" placeholder="Observaciones para este parámetro..."
                                                          {% if detalle.observaciones %}value="{{ detalle.observaciones }}"{% endif %}></textarea>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Decisión Final -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-clipboard-check me-2"></i>
                                        Decisión Final Manual
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="decision_final" id="decisionAprobar" value="Aprobada" required>
                                        <label class="form-check-label text-success" for="decisionAprobar">
                                            <i class="fas fa-thumbs-up fa-2x me-2"></i>
                                            <div>
                                                <strong>APROBAR PRUEBA</strong><br>
                                                <small class="text-muted">La prueba cumple con los requisitos de calidad</small>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="decision_final" id="decisionRechazar" value="Rechazada">
                                        <label class="form-check-label text-danger" for="decisionRechazar">
                                            <i class="fas fa-thumbs-down fa-2x me-2"></i>
                                            <div>
                                                <strong>RECHAZAR PRUEBA</strong><br>
                                                <small class="text-muted">La prueba NO cumple con los requisitos de calidad</small>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <!--<div class="form-check">
                                        <input class="form-check-input" type="radio" name="decision_final" id="decisionCondicional" value="APROBADA_CONDICIONAL">
                                        <label class="form-check-label text-warning" for="decisionCondicional">
                                            <i class="fas fa-exclamation-triangle fa-2x me-2"></i>
                                            <div>
                                                <strong>APROBAR CON OBSERVACIONES</strong><br>
                                                <small class="text-muted">Aprobar con condiciones específicas</small>
                                            </div>
                                        </label>
                                    </div>-->
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-file-signature me-2"></i>
                                        Documentación Final
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="observacionesFinal" class="form-label">
                                            <i class="fas fa-sticky-note me-1"></i> Observaciones Generales
                                        </label>
                                        <textarea class="form-control" id="observacionesFinal" name="observaciones_generales" 
                                                  rows="3" placeholder="Observaciones adicionales sobre la prueba..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ✅ NUEVO: Card para Almacén Destino (solo visible si se aprueba) -->
                    <div class="card mt-3" id="cardAlmacenDestino">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-warehouse me-2"></i>
                                    Almacén Destino
                            </h6>
                        </div>
                        <div class="card-body">
                            <select class="form-select" id="almacen_destino" name="almacen_destino">
                                <option value="">-- Seleccione un almacén de producto terminado --</option>
                                {% for almacen in almacenes %}
                                    <option value="{{ almacen.id }}">{{ almacen.nombre }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">El producto se ingresará a este almacén si la prueba es aprobada.</small>
                        </div>
                    </div>
                </div>

                <!-- Validación de firma -->
                <div class="alert alert-warning mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirmacionResponsable" required>
                        <label class="form-check-label" for="confirmacionResponsable">
                            <i class="fas fa-signature me-2"></i>
                            <strong>CONFIRMACIÓN DEL RESPONSABLE</strong><br>
                                Yo, <strong>{{ user.get_full_name|default:user.username }}</strong>, confirmo que he revisado todos los parámetros 
                                y tomo la decisión final sobre el resultado de esta prueba química. Esta acción registrará 
                                mi nombre como responsable de la evaluación y no podrá ser revertida.
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary"id="btnConfirmarConclusion">
                        <i class="fas fa-check-double me-1"></i>Confirmar Conclusión
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para detalles del parámetro -->
<div class="modal fade" id="modalDetalleParametro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-vial me-2"></i>
                    <span id="modalParametroNombre"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-4">Valor Medido:</dt>
                    <dd class="col-sm-8" id="modalParametroValor"></dd>
                    
                    <dt class="col-sm-4">Rango Permitido:</dt>
                    <dd class="col-sm-8" id="modalParametroRango"></dd>
                    
                    <dt class="col-sm-4">Unidad:</dt>
                    <dd class="col-sm-8" id="modalParametroUnidad"></dd>
                    
                    <dt class="col-sm-4">Estado:</dt>
                    <dd class="col-sm-8">
                        <span class="badge" id="modalParametroEstado"></span>
                    </dd>
                    
                    <dt class="col-sm-4">Observaciones:</dt>
                    <dd class="col-sm-8" id="modalParametroObservaciones"></dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Template para nuevos parámetros dinámicos -->
<!-- <template id="templateParametroDinamico">
    <div class="parametro-dinamico card mb-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-5">
                    <select class="form-control form-control-sm parametro-select" required>
                        <option value="">Seleccionar parámetro...</option>
                        {% for parametro in parametros_disponibles %}
                        <option value="{{ parametro.id }}" 
                                data-min="{{ parametro.valor_minimo|default:'' }}"
                                data-max="{{ parametro.valor_maximo|default:'' }}"
                                data-unidad="{{ parametro.unidad_medida|default:'' }}">
                            {{ parametro.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm valor-input" 
                           placeholder="Valor medido" required>
                    <small class="form-text text-muted unidad-text"></small>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm observacion-input" 
                           placeholder="Observación">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-danger btn-eliminar-dinamico">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</template> -->

<template id="templateParametroDinamico">
    <div class="parametro-dinamico card mb-3">
        <div class="card-body">
            <div class="row align-items-end">
                <!-- Selector de parámetro -->
                <div class="col-md-4">
                    <label class="form-label small">Parámetro *</label>
                    <select class="form-control form-control-sm parametro-select" required>
                        <option value="">Seleccionar...</option>
                        {% for parametro in parametros_disponibles %}
                        <option value="{{ parametro.id }}" 
                                data-tipo="{{ parametro.tipo }}"
                                data-unidad="{{ parametro.unidad_medida|default:'' }}">
                            {{ parametro.nombre }}
                            {% if parametro.unidad_medida %}({{ parametro.unidad_medida }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Valor medido (siempre visible) -->
                <div class="col-md-3 valor-container">
                    <label class="form-label small valor-label">Valor Medido *</label>
                    <input type="text" class="form-control form-control-sm valor-input" 
                           placeholder="Ingrese valor" required>
                    <small class="form-text text-muted unidad-text"></small>
                </div>
                <!-- Checkbox de cumplimiento (oculto por defecto) -->
                <div class="col-md-2 cumplimiento-container" style="display: none;">
                    <label class="form-label small d-block">Cumplimiento</label>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input cumplimiento-check">
                        <label class="form-check-label small">Cumple</label>
                    </div>
                </div>
                <!-- Observaciones -->
                <div class="col-md-2">
                    <label class="form-label small">Observaciones</label>
                    <input type="text" class="form-control form-control-sm observacion-input" 
                           placeholder="Opicional">
                </div>
                <!-- Botón eliminar -->
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-danger btn-eliminar-dinamico">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

{% endblock %}

{% block javascript %}

<script>
// Función para mostrar mensajes toast/alert
function mostrarMensaje(tipo, mensaje, duracion = 3000) {
    // Tipos: 'success', 'error', 'warning', 'info'
    
    // Si ya existe una librería de notificaciones, úsala
    // De lo contrario, crea una notificación simple
    
    // Opción 1: Usar Bootstrap Toast (si estás usando Bootstrap 5)
    if (typeof bootstrap !== 'undefined') {
        // Crear elemento toast
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            // Crear contenedor si no existe
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '1050';
            document.body.appendChild(container);
        }
        
        // Crear toast
        const toastId = 'toast-' + Date.now();
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-bg-${tipo === 'error' ? 'danger' : tipo} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        toastEl.id = toastId;
        
        // Contenido del toast
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${getIconoPorTipo(tipo)} me-2"></i>
                    ${mensaje}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                        data-bs-dismiss="toast"></button>
            </div>
        `;
        
        document.getElementById('toastContainer').appendChild(toastEl);
        
        // Mostrar toast
        const toast = new bootstrap.Toast(toastEl, {
            delay: duracion,
            autohide: true
        });
        toast.show();
        
        // Remover después de ocultar
        toastEl.addEventListener('hidden.bs.toast', function() {
            toastEl.remove();
        });
        
    } else {
        // Opción 2: Alert simple (como fallback)
        alert(`${tipo.toUpperCase()}: ${mensaje}`);
    }
}

// Función auxiliar para obtener icono según tipo
function getIconoPorTipo(tipo) {
    const iconos = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    return iconos[tipo] || 'info-circle';
}

function getCSRFToken() {
    return '{{ csrf_token }}';  // Esto funciona si estás en un template
}

    // Guardar cambios (con UUID) - VERSIÓN CORREGIDA
$(document).on('click', '.btn-guardar', function() {
    const $btn = $(this);
    const parametroId = $btn.data('id');  // UUID del parámetro
    const $fila = $(`#parametro-${parametroId}`);
    const nuevoValor = $fila.find('.valor-edit').val().trim();
    
    // Validación básica
    if (!nuevoValor) {
        mostrarMensaje('warning', 'Ingrese un valor para el parámetro');
        $fila.find('.valor-edit').focus();
        return;
    }
    
    // Validar si es un número (para parámetros numéricos)
    const valorNumerico = parseFloat(nuevoValor);
    if (isNaN(valorNumerico) && !/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(nuevoValor)) {
        mostrarMensaje('warning', 'Ingrese un valor válido (numérico o texto)');
        $fila.find('.valor-edit').focus();
        return;
    }
    
    // Preparar datos para enviar
    const formData = new FormData();
    formData.append('valor_medido', nuevoValor);
    formData.append('csrfmiddlewaretoken', getCSRFToken());
    
    // Cambiar estado del botón
    $btn.prop('disabled', true)
        .html('<i class="fas fa-spinner fa-spin me-1"></i>');
    
    console.log('Enviando edición para parámetro ID:', parametroId);
    console.log('Nuevo valor:', nuevoValor);
    console.log('URL:', `/produccion/parametro-prueba/${parametroId}/editar/`);
    
    // Usar fetch en lugar de jQuery.ajax para mayor control
    fetch(`/produccion/parametro-prueba/${parametroId}/editar/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        console.log('Respuesta HTTP recibida, status:', response.status);
        
        // Verificar si la respuesta es JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('La respuesta del servidor no es JSON');
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Respuesta JSON parseada:', data);
        
        if (data.success) {
            // 1. Actualizar valor en la tabla
            $fila.find('.valor-actual').text(nuevoValor);
            
            // 2. Cambiar estilos según cumplimiento
            const esAprobado = data.dentro_especificacion;
            
            if (esAprobado) {
                $fila.removeClass('table-danger').addClass('table-success');
                $fila.find('.estado-badge')
                    .removeClass('bg-danger')
                    .addClass('bg-success')
                    .html('<i class="fas fa-check me-1"></i> OK');
                
                // Actualizar contadores (si cambiaba de rechazado a aprobado)
                if ($fila.hasClass('table-danger')) {
                    contadorAprobados++;
                    contadorRechazados = Math.max(0, contadorRechazados - 1);
                }
            } else {
                $fila.removeClass('table-success').addClass('table-danger');
                $fila.find('.estado-badge')
                    .removeClass('bg-success')
                    .addClass('bg-danger')
                    .html('<i class="fas fa-times me-1"></i> Falla');
                
                // Actualizar contadores (si cambiaba de aprobado a rechazado)
                if ($fila.hasClass('table-success')) {
                    contadorRechazados++;
                    contadorAprobados = Math.max(0, contadorAprobados - 1);
                }
            }
            
            // 3. Actualizar contadores globales
            //actualizarContadores();
            
            // 4. Mostrar mensaje de éxito
            mostrarMensaje('success', '¡Valor actualizado correctamente!');
            
            // 5. Restaurar modo visualización
            $fila.find('.valor-actual').removeClass('d-none');
            $fila.find('.valor-edit').addClass('d-none');
            $fila.find('.btn-editar').removeClass('d-none');
            $fila.find('.btn-guardar, .btn-cancelar').addClass('d-none');
            
        } else {
            // Mostrar error del servidor
            mostrarMensaje('error', data.message || 'Error al actualizar el parámetro');
            
            // Mantener en modo edición
            $btn.prop('disabled', false)
                .html('<i class="fas fa-save"></i>');
        }
    })
    .catch(error => {
        console.error('Error en la petición:', error);
        
        // Mostrar error detallado
        let mensajeError = 'Error de conexión con el servidor';
        if (error.message.includes('JSON')) {
            mensajeError = 'El servidor respondió con un formato no válido. Revise la consola.';
        }
        
        mostrarMensaje('error', mensajeError);
        
        // Restaurar botón
        $btn.prop('disabled', false)
            .html('<i class="fas fa-save"></i>');
            
        // Mostrar error en consola para depuración
        console.error('Detalles del error:', error);
    });
});

// También mejora la función para cancelar edición:
$(document).on('click', '.btn-cancelar', function() {
    const parametroId = $(this).data('id');
    const $fila = $(`#parametro-${parametroId}`);
    
    // Restaurar valor original
    const valorOriginal = $fila.find('.valor-actual').text();
    $fila.find('.valor-edit').val(valorOriginal);
    
    // Cambiar a modo visualización
    $fila.find('.valor-edit').addClass('d-none');
    $fila.find('.valor-actual').removeClass('d-none');
    $fila.find('.btn-editar').removeClass('d-none');
    $fila.find('.btn-guardar, .btn-cancelar').addClass('d-none');
});

// Y mejora la función de edición para guardar el valor original:
$(document).on('click', '.btn-editar', function() {
    const parametroId = $(this).data('id');
    const $fila = $(`#parametro-${parametroId}`);
    const valorActual = $fila.find('.valor-actual').text().trim();
    
    // Configurar campo de edición con el valor actual
    $fila.find('.valor-edit').val(valorActual);
    
    // Cambiar a modo edición
    $fila.find('.valor-actual').addClass('d-none');
    $fila.find('.valor-edit').removeClass('d-none').focus();
    $(this).addClass('d-none');
    $fila.find('.btn-guardar, .btn-cancelar').removeClass('d-none');
});

// ============================================
// 4. AGREGAR NUEVOS PARÁMETROS (con UUID de prueba)
// ============================================
$('#btnAgregarParametro, #btnAgregarParametroModal').on('click', function() {
    $('#nuevosParametrosContainer').toggle();
    if ($('#nuevosParametrosContainer').is(':visible')) {
        agregarCampoParametro();
    }
});
    
/* function agregarCampoParametro() {
    const template = document.getElementById('templateParametroDinamico');
    const clone = template.content.cloneNode(true);
        
    const $clone = $(clone);
        
    // Configurar eventos
    $clone.find('.parametro-select').on('change', function() {
        const unidad = $(this).find('option:selected').data('unidad') || '';
        $(this).closest('.parametro-dinamico').find('.unidad-text').text('Unidad: ' + unidad);
    });
        
    $clone.find('.btn-eliminar-dinamico').on('click', function() {
        $(this).closest('.parametro-dinamico').remove();
    });
        
    $('#parametrosDinamicos').append($clone);
} */
    
// ============================================
// AGREGAR PARÁMETROS DINÁMICOS (con organolépticos)
// ============================================

function agregarCampoParametro() {
    const template = document.getElementById('templateParametroDinamico');
    const clone = template.content.cloneNode(true);
    const $clone = $(clone);

    // Mostrar/ocultar checkbox según tipo seleccionado
    $clone.find('.parametro-select').on('change', function() {
        const $row = $(this).closest('.parametro-dinamico');
        const selected = $(this).find('option:selected');
        const tipo = selected.data('tipo');
        const unidad = selected.data('unidad') || '';

        // Mostrar unidad
        $row.find('.unidad-text').text(unidad ? `Unidad: ${unidad}` : '');

        // Checkbox: visible solo si es organoléptico
        if (tipo === 'organoleptico') {
            $row.find('.cumplimiento-container').show();
            $row.find('.valor-label').text('Valor medido (texto) *');
            $row.find('.valor-input').attr('placeholder', 'Ej: Amarillo, olor agradable...');
        } else {
            $row.find('.cumplimiento-container').hide();
            $row.find('.cumplimiento-check').prop('checked', false); // reset
            $row.find('.valor-label').text('Valor Medido *');
            $row.find('.valor-input').attr('placeholder', 'Ingrese valor numérico');
        }
    });

    // Botón eliminar
    $clone.find('.btn-eliminar-dinamico').on('click', function() {
        $(this).closest('.parametro-dinamico').remove();
    });

    $('#parametrosDinamicos').append($clone);
}

$('#btnAgregarMas').on('click', agregarCampoParametro);
    
// Guardar nuevos parámetros
$('#formAgregarParametros').on('submit', function(e) {
    e.preventDefault();

    console.log('=== INICIANDO ENVÍO DE PARÁMETROS ===');

    const parametros = [];
    let valido = true;
    let contador = 0;
        
    $('.parametro-dinamico').each(function() {
        const $row = $(this);
        const $select = $row.find('.parametro-select');
        const $valor = $row.find('.valor-input');
        const $observacion = $row.find('.observacion-input');
        const $checkbox = $row.find('.cumplimiento-check');
        const tipo = $select.find('option:selected').data('tipo');

        const parametroId = $select.val();
        const valorMedido = $valor.val().trim();

        if (!parametroId || !valorMedido) {
            valido = false;
            $row.addClass('border-danger');
            return true; // continuar
        }
        $row.removeClass('border-danger');

        const parametro = {
            parametro_id: parametroId,
            valor_medido: valorMedido,
            observaciones: $observacion.val().trim() || '',
            // Solo incluimos cumplimiento si es organoléptico, pero podemos enviar siempre
            cumplimiento: tipo === 'organoleptico' ? $checkbox.is(':checked') : null
        };

        parametros.push(parametro);
    });
    
    console.log('Total parámetros válidos:', parametros.length);
    console.log('Parámetros a enviar:', parametros);

    if (!valido) {
        mostrarMensaje('warning', 'Complete todos los campos requeridos (marcados en rojo)');
        return;
    }
        
    if (parametros.length === 0) {
        mostrarMensaje('warning', 'Agregue al menos un parámetro');
        return;
    }
        
    // Configurar botón de envío
    const $submitBtn = $('#formAgregarParametros button[type="submit"]');
    $submitBtn.prop('disabled', true)
        .html('<i class="fas fa-spinner fa-spin me-1"></i> Guardando...');
    
    const pruebaId = "{{ prueba.id }}";
    const url = `/produccion/prueba-quimica/${pruebaId}/agregar-parametros/`;

    // **DEBUG: Mostrar datos que se enviarán**
    console.log('=== DATOS A ENVIAR ===');
    console.log('URL:', url);
    console.log('Prueba ID:', pruebaId);
    console.log('Parámetros:', parametros);
    console.log('CSRF Token:', getCSRFToken());

    // Crear FormData para enviar como multipart/form-data
    /*const formData = new FormData();
    formData.append('parametros', JSON.stringify(parametros));*/

    // **OPCIÓN 1: Enviar como JSON puro (RECOMENDADO)**
    const dataToSend = {
        parametros: parametros,
        prueba_id: pruebaId
    };

    console.log('Datos a enviar (JSON):', JSON.stringify(dataToSend));

    // **IMPORTANTE: Agregar el CSRF token al FormData**
    // Django busca 'csrfmiddlewaretoken' en POST data, no solo en headers
    const csrfToken = getCSRFToken();
    //formData.append('csrfmiddlewaretoken', csrfToken);
    
    /*console.log('FormData entries:');
    for (let pair of formData.entries()) {
        console.log(pair[0] + ': ' + pair[1]);
    }*/

    // Enviar datos al servidor
    fetch(`/produccion/prueba-quimica/${pruebaId}/agregar-parametros/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,  // Para Django's CSRF protection via headers //getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            parametros: parametros,
            })
        //formData
        /*JSON.stringify({
            parametros: parametros,
            csrfmiddlewaretoken: getCSRFToken()
        })*/
    })
    .then(response => {
        console.log('Respuesta HTTP recibida. Status:', response.status);
        
        if (!response.ok) {
            console.error('Error HTTP:', response.status, response.statusText);
            throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
    })
    //response.json())
    /*.then(response => {
         No uses 'Content-Type' header cuando uses FormData
        //const contentType = response.headers.get('content-type');
        // Verificar si la respuesta es JSON
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        }
        throw new Error('Respuesta no es JSON');
        
        console.log('Respuesta recibida. Status:', response.status, response.statusText);
        
        if (!response.ok) {
            // Si es error 400, obtener más detalles
            if (response.status === 400) {
                return response.text().then(text => {
                    console.error('Error 400 - Detalles:', text);
                    throw new Error(`Error 400: ${text}`);
                });
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        }
        return response.text().then(text => {
            console.warn('Respuesta no es JSON:', text);
            throw new Error('Respuesta no es JSON');
        });
    })*/
    .then(data => {
        console.log('Datos recibidos del servidor:', data);

        if (data.success) {
            mostrarMensaje('success', data.message || 'Parámetros agregados correctamente'); 
            
            // Ocultar formulario de nuevos parámetros
            $('#nuevosParametrosContainer').hide();
            $('#parametrosDinamicos').empty();

            // Recargar la página después de un breve retraso
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            mostrarMensaje('error', data.message || 'Error al guardar los parámetros');
            $submitBtn.prop('disabled', false)
            .html('<i class="fas fa-save me-1"></i> Guardar Todos');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('error', 'Error de conexión al servidor');
        $submitBtn.prop('disabled', false)
            .html('<i class="fas fa-save me-1"></i> Guardar Todos');
    });
});


// ============================================
// 2. MANEJO DEL MODAL DE CONCLUSIÓN
// ============================================
// URL de la vista
const URL_CONCLUIR = "{% url 'concluir_prueba_quimica' prueba.id %}";

$('#btnConcluirPrueba').on('click', function() {
    // Verificar que haya parámetros registrados
    if ({{ total_parametros }} == 0) {
        Swal.fire({
            title: 'Prueba sin parámetros',
            text: 'Debe registrar al menos un parámetro antes de concluir la prueba.',
            icon: 'warning',
            confirmButtonText: 'Entendido'
        });
        return;
    }
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('modalConcluirPrueba'));
    modal.show();
});

$('#formConcluirPrueba').on('submit', function(e) {
    e.preventDefault(); // Prevenir envío normal
    
    console.log('=== FORMULARIO ENVIADO ===');
    
    // Validaciones básicas
    const decisionSeleccionada = $('input[name="decision_final"]:checked').val();
    const almacen = $('#almacen_destino').val();

    if (!decisionSeleccionada) {
        mostrarMensaje('warning', 'Debe seleccionar una decisión final');
        return false;
    }

    // Si la decisión es Aprobada, el almacén debe estar seleccionado
    if (decisionSeleccionada === 'Aprobada' && !almacen) {
        mostrarMensaje('warning', 'Debe seleccionar un almacén destino para el producto aprobado.');
        return false;
    }
    
    /*const resultadoFinal = $('#resultadoFinal').val().trim();
    if (!resultadoFinal) {
        mostrarMensaje('warning', 'Debe ingresar un resultado final');
        $('#resultadoFinal').focus();
        return false;
    }*/
    
    if (!$('#confirmacionResponsable').is(':checked')) {
        mostrarMensaje('warning', 'Debe confirmar que es el responsable');
        return false;
    }
    
    // Preparar datos
    const formData = new FormData(this);
    
    // Agregar CSRF token manualmente
    const csrfToken = $('input[name="csrfmiddlewaretoken"]', this).val();
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    // Mostrar datos en consola para depuración
    console.log('Datos a enviar:');
    for (let pair of formData.entries()) {
        console.log(pair[0] + ': ' + pair[1]);
    }
    
    // Mostrar confirmación
    const decisionTexto = decisionSeleccionada === 'Aprobada' ? 'APROBAR' : 'RECHAZAR';
    
    Swal.fire({
        title: `¿${decisionTexto} la prueba?`,
        html: `
            <div class="text-start">
                <p><strong>Resumen:</strong></p>
                <ul>
                    <li><strong>Total Parámetros:</strong> {{ total_parametros }}</li>
                    <li><strong>Decisión:</strong> ${decisionTexto}</li>
                    <li><strong>Responsable:</strong> {{ user.get_full_name|default:user.username }}</li>
                </ul>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, confirmar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Deshabilitar botón
            const $btn = $('#btnConfirmarConclusion');
            $btn.prop('disabled', true)
                .html('<i class="fas fa-spinner fa-spin me-1"></i> Procesando...');
            
            // Enviar datos
            fetch(URL_CONCLUIR, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => {
                console.log('Status:', response.status);
                console.log('Response:', response);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Respuesta:', data);
                
                if (data.success) {
                    Swal.fire({
                        title: '¡Éxito!',
                        text: data.message,
                        icon: 'success',
                        confirmButtonText: 'Continuar'
                    }).then(() => {
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        } else {
                            location.reload();
                        }
                    });
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.message,
                        icon: 'error',
                        confirmButtonText: 'Entendido'
                    });
                    $btn.prop('disabled', false)
                        .html('<i class="fas fa-check-double me-1"></i> Confirmar');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error de conexión',
                    text: 'No se pudo conectar con el servidor',
                    icon: 'error',
                    confirmButtonText: 'Entendido'
                });
                $btn.prop('disabled', false)
                    .html('<i class="fas fa-check-double me-1"></i> Confirmar');
            });
        }
    });
    
    return false;
});

// Función para recolectar observaciones de parámetros
/*function recolectarObservacionesParametros() {
    const observaciones = {};
    
    $('.observacion-parametro').each(function() {
        const textarea = $(this);
        const name = textarea.attr('name');
        const value = textarea.val().trim();
        
        if (name && value) {
            observaciones[name] = value;
        }
    });
    
    return observaciones;
}
*/
// Función para validar formulario de conclusión
/*function validarFormularioConcluir() {
    // Verificar que se haya seleccionado una decisión
    const decisionSeleccionada = $('input[name="decision_final"]:checked').val();
    if (!decisionSeleccionada) {
        mostrarMensaje('warning', 'Debe seleccionar una decisión final');
        return false;
    }
    
    // Verificar confirmación del responsable
    if (!$('#confirmacionResponsable').is(':checked')) {
        mostrarMensaje('warning', 'Debe confirmar que es el responsable de la evaluación');
        return false;
    }
    
    // Verificar resultado final
    const resultadoFinal = $('#resultadoFinal').val().trim();
    if (!resultadoFinal) {
        mostrarMensaje('warning', 'Debe ingresar un resultado final');
        $('#resultadoFinal').focus();
        return false;
    }
    
    return true;
}

// Manejar el clic en el botón Confirmar
$('#btnConfirmarConclusion').on('click', function() {
    console.log('=== INICIANDO CONCLUSIÓN ===');
    console.log('Botón Confirmar clickeado');
    
    // Verificar que estamos en el contexto correcto
    console.log('Elementos .observacion-parametro:', $('.observacion-parametro').length);
    console.log('Formulario existe:', $('#formConcluirPrueba').length);
    console.log('Modal visible:', $('#modalConcluirPrueba').is(':visible'));
    
    // Validar formulario
    if (!validarFormularioConcluir()) {
        console.log('Validación fallida');
        return;
    }
    
    // Recolectar datos del formulario
    const formData = new FormData(document.getElementById('formConcluirPrueba'));
    
    // Agregar observaciones de parámetros
    console.log('Recolectando observaciones de parámetros...');
    const observacionesParametros = recolectarObservacionesParametros();
    console.log('Observaciones recolectadas:', observacionesParametros);
    
    Object.entries(observacionesParametros).forEach(([key, value]) => {
        formData.append(key, value);
        console.log('Agregando al formData:', key, '=', value);
    });
    
    // Verificar datos antes de enviar
    console.log('Datos a enviar:');
    for (let pair of formData.entries()) {
        console.log(pair[0] + ': ' + pair[1]);
    }
    
    // Mostrar confirmación final
    const decisionSeleccionada = $('input[name="decision_final"]:checked').val();
    const decisionTexto = {
        'APROBADA': 'APROBAR',
        'RECHAZADA': 'RECHAZAR',
        'APROBADA_CONDICIONAL': 'APROBAR CON OBSERVACIONES'
    }[decisionSeleccionada] || 'DESCONOCIDA';

    console.log('Mostrando confirmación con decisión:', decisionTexto);
    
    Swal.fire({
        title: `¿${decisionTexto} la prueba?`,
        html: `
            <div class="text-start">
                <p><strong>Resumen de la prueba:</strong></p>
                <ul>
                    <li><strong>Total Parámetros:</strong> {{ total_parametros }}</li>
                    <li><strong>Aprobados automáticamente:</strong> {{ parametros_aprobados_auto }}</li>
                    <li><strong>% Aprobación automática:</strong> {{ porcentaje_aprobacion_auto }}%</li>
                    <li><strong>Decisión final:</strong> ${decisionTexto}</li>
                    <li><strong>Responsable:</strong> {{ user.get_full_name|default:user.username }}</li>
                </ul>
                <p class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i> Esta acción no se puede deshacer.</p>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, confirmar',
        cancelButtonText: 'Cancelar',
        width: 600
    }).then((result) => {
        if (result.isConfirmed) {
            console.log('Usuario confirmó, enviando datos...');
            
            // Deshabilitar botón y mostrar loading
            const $btn = $('#btnConfirmarConclusion');
            $btn.prop('disabled', true)
                .html('<i class="fas fa-spinner fa-spin me-1"></i> Procesando...');
            
            // Enviar datos al servidor usando fetch
            fetch(URLS.concluirPrueba, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => {
                console.log('Respuesta del servidor:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Datos recibidos:', data);
                
                if (data.success) {
                    // Mostrar mensaje de éxito
                    Swal.fire({
                        title: '¡Éxito!',
                        text: data.message,
                        icon: 'success',
                        confirmButtonText: 'Continuar'
                    }).then(() => {
                        // Redirigir a la página de detalle
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        } else {
                            // Recargar la página
                            location.reload();
                        }
                    });
                } else {
                    // Mostrar error
                    mostrarMensaje('error', data.message || 'Error al concluir la prueba');
                    
                    // Rehabilitar botón
                    $btn.prop('disabled', false)
                        .html('<i class="fas fa-check-double me-1"></i> Confirmar Conclusión');
                }
            })
            .catch(error => {
                console.error('Error en la petición:', error);
                mostrarMensaje('error', 'Error de conexión con el servidor');
                
                // Rehabilitar botón
                $btn.prop('disabled', false)
                    .html('<i class="fas fa-check-double me-1"></i> Confirmar Conclusión');
            });
        }
    });
});
*/
// También permitir envío con Enter en los textareas
$('#formConcluirPrueba textarea').on('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        $('#btnConfirmarConclusion').click();
    }
});

</script>
{% endblock %}