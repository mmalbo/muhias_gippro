{% extends "base/base.html" %}
{% load static %}

{% block contenido %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-title-box">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="page-title mb-0">
                            <i class="fas fa-flask me-2"></i>
                            Prueba Química #{{ prueba.nomenclador_prueba }}
                        </h4>

                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-{{ prueba.estado|lower }} fs-6 p-2" style="color: grey;">
                            <i class="fas fa-{{ prueba.estado|lower }} me-1"></i>
                            {{ prueba.estado|upper }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna izquierda: Información y Acciones -->
        <div class="col-lg-4">
            <!-- Información de la Prueba -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i> Información de la Prueba
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Producción:</dt>
                        <dd class="col-sm-7">
                            <strong>{{ prueba.produccion.lote }}</strong>
                        </dd>
                        
                        <dt class="col-sm-5">Producto:</dt>
                        <dd class="col-sm-7">{{ prueba.produccion.catalogo_producto.nombre_comercial }}</dd>
                        
                        <dt class="col-sm-5">Fecha Prueba:</dt>
                        <dd class="col-sm-7">{{ prueba.fecha_prueba|date:"d/m/Y" }}</dd>
                        
                        <dt class="col-sm-5">Fecha Vencimiento:</dt>
                        <dd class="col-sm-7">
                            {% if prueba.fecha_vencimiento %}
                                {{ prueba.fecha_vencimiento|date:"d/m/Y" }}
                            {% else %}
                                <span class="text-muted">No especificado</span>
                            {% endif %}
                        </dd>
                        
                        {% if prueba.evaluado_por %}
                        <dt class="col-sm-5">Evaluado por:</dt>
                        <dd class="col-sm-7">{{ prueba.evaluado_por.get_full_name|default:prueba.evaluado_por.username }}</dd>
                        
                        <dt class="col-sm-5">Fecha Evaluación:</dt>
                        <dd class="col-sm-7">{{ prueba.fecha_evaluacion|date:"d/m/Y" }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Panel de Acciones -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i> Acciones
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <!-- Botón para agregar parámetros (siempre visible)
                        <button type="button" class="btn btn-primary" id="btnAgregarParametroModal">
                            <i class="fas fa-plus-circle me-2"></i> Agregar Parámetros
                        </button> -->
                        
                        <!-- Botón para concluir prueba (si está pendiente) -->
                        {% if prueba.estado != 'APROBADA' and prueba.estado != 'RECHAZADA' and prueba.estado != 'CANCELADA' %}
                        <button type="button" class="btn btn-success" id="btnConcluirPrueba">
                            <i class="fas fa-flag-checkered me-2"></i> Concluir Prueba
                        </button>
                        {% endif %}
                        
                        <!-- Botón para cambiar estado 
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-info dropdown-toggle" 
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-sync-alt me-2"></i> Cambiar Estado
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="cambiarEstado('EN_PROCESO')">
                                    <i class="fas fa-play text-info me-2"></i> En Proceso
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="cambiarEstado('COMPLETADA')">
                                    <i class="fas fa-check text-primary me-2"></i> Completada
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="cambiarEstado('CANCELADA')">
                                    <i class="fas fa-ban me-2"></i> Cancelar
                                </a></li>
                            </ul>
                        </div>-->
                        
                        <!-- Botones adicionales -->
                        <a href="{% url 'produccion_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i> Volver a Listado
                        </a>
                    </div>
                </div>
            </div>

            <!-- Resultado Final -->
            {% if prueba.resultado_final %}
            <div class="card border-{% if prueba.aprobado %}success{% else %}danger{% endif %}">
                <div class="card-header bg-{% if prueba.aprobado %}success{% else %}danger{% endif %} text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-{% if prueba.aprobado %}thumbs-up{% else %}thumbs-down{% endif %} me-2"></i>
                        Resultado Final: {% if prueba.aprobado %} 'APROBADA' {% else %} 'RECHAZADA' {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Conclusión:</strong></p>
                    <p class="mb-0">{{ prueba.resultado_final|linebreaks }}</p>
                    
                    {% if prueba.observaciones %}
                    <hr>
                    <p class="mb-2"><strong>Observaciones:</strong></p>
                    <p class="mb-0 text-muted">{{ prueba.observaciones|linebreaks }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Columna derecha: Parámetros -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-check me-2"></i> Parámetros Evaluados
                    </h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-primary me-2" id="btnAgregarParametro">
                            <i class="fas fa-plus me-1"></i> Agregar
                        </button>
                        <span class="badge bg-primary">Total: <span id="contadorTotal">{{ total_parametros }}</span></span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Contenedor para nuevos parámetros (formulario dinámico) -->
                    <div id="nuevosParametrosContainer" class="p-3 border-bottom" style="display: none;">
                        <h6 class="mb-3"><i class="fas fa-plus-circle me-2"></i> Nuevos Parámetros</h6>
                        <form id="formAgregarParametros">
                            <div id="parametrosDinamicos"></div>
                            <div class="d-flex justify-content-between mt-3">
                                <button type="button" class="btn btn-sm btn-outline-success" id="btnAgregarMas">
                                    <i class="fas fa-plus me-1"></i> Agregar Otro
                                </button>
                                <div>
                                    <button type="button" class="btn btn-sm btn-secondary me-2" id="btnCancelarAgregar">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fas fa-save me-1"></i> Guardar Todos
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Tabla de parámetros existentes -->
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="20%">Parámetro</th>
                                    <th width="15%">Valor Medido</th>
                                    <th width="15%">Rango Esperado</th>
                                    <th width="10%">Unidad</th>
                                    <th width="10%">Estado</th>
                                    <th width="25%">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaParametros">
                                {% for parametro in parametros %}
                                <tr id="parametro-{{ parametro.id }}" class="{% if parametro.dentro_especificacion %}table-success{% else %}table-danger{% endif %}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <strong>{{ parametro.parametro.nombre }}</strong>                                       
                                    </td>
                                    <td>
                                        <span class="valor-actual">{{ parametro.valor_medido }}</span>
                                        <input type="text" class="form-control form-control-sm valor-edit d-none" 
                                               value="{{ parametro.valor_medido }}" 
                                               data-id="{{ parametro.id }}">
                                    </td>
                                    <td>
                                        {% if parametro.parametro.valor_minimo and parametro.parametro.valor_maximo %}
                                        {{ parametro.parametro.valor_minimo }} - {{ parametro.parametro.valor_maximo }}
                                        {% elif parametro.parametro.valor_referencia %}
                                        {{ parametro.parametro.valor_referencia }}
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ parametro.parametro.unidad_medida|default:"-" }}</td>
                                    <td>
                                        <span class="badge {% if parametro.parametro.cumplimiento %}bg-success{% else %}bg-danger{% endif %} estado-badge">
                                            <i class="fas fa-{% if parametro.parametro.cumplimiento %}check{% else %}times{% endif %} me-1"></i>
                                            {% if parametro.parametro.cumplimiento %}OK{% else %}Falla{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Editar valor -->
                                            <button type="button" class="btn btn-outline-warning btn-editar" 
                                                    data-id="{{ parametro.id }}"
                                                    data-bs-toggle="tooltip" title="Editar valor">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            
                                            <!-- Guardar cambios (oculto inicialmente) -->
                                            <button type="button" class="btn btn-outline-success btn-guardar d-none" 
                                                    data-id="{{ parametro.id }}"
                                                    data-bs-toggle="tooltip" title="Guardar cambios">
                                                <i class="fas fa-save"></i>
                                            </button>
                                            
                                            <!-- Cancelar edición (oculto inicialmente) -->
                                            <button type="button" class="btn btn-outline-secondary btn-cancelar d-none" 
                                                    data-id="{{ parametro.id }}"
                                                    data-bs-toggle="tooltip" title="Cancelar">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            
                                            <!-- Ver detalles -->
                                            <button type="button" class="btn btn-outline-info" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#modalDetalleParametro"
                                                    data-nombre="{{ parametro.parametro.nombre }}"
                                                    data-valor="{{ parametro.valor_medido }}"
                                                    data-min="{{ parametro.parametro.valor_minimo|default:'' }}"
                                                    data-max="{{ parametro.parametro.valor_maximo|default:'' }}"
                                                    data-unidad="{{ parametro.parametro.unidad_medida|default:'' }}"
                                                    data-estado="{% if parametro.dentro_especificacion %}OK{% else %}Falla{% endif %}"
                                                    data-observaciones="{{ parametro.observaciones|default:'' }}"
                                                    data-bs-toggle="tooltip" title="Ver detalles">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            
                                            <!-- Eliminar -->
                                            <button type="button" class="btn btn-outline-danger btn-eliminar" 
                                                    data-id="{{ parametro.id }}"
                                                    data-nombre="{{ parametro.parametro.nombre }}"
                                                    data-bs-toggle="tooltip" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr id="sinParametros">
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-flask fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No hay parámetros registrados</h5>
                                        <p class="text-muted mb-0">Agregue parámetros para evaluar esta prueba</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="contadorAprobados">{{ parametros_aprobados }}</span> de 
                                <span id="contadorTotalFooter">{{ total_parametros }}</span> parámetros aprobados
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            {% if prueba.estado != 'APROBADA' and prueba.estado != 'RECHAZADA' %}
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btnCalcularResultados">
                                <i class="fas fa-calculator me-1"></i> Calcular Resultados
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gráfico de Resultados -->
            {% if total_parametros > 0 %}
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i> Resumen Gráfico
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="graficoPrueba" height="100"></canvas>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tarjetas de Resumen -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card card-hover border-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="text-muted fw-normal mt-0 mb-2">Total Parámetros</h5>
                            <h3 class="my-2" id="totalParametros">{{ total_parametros }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-list-check text-primary fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card card-hover border-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="text-muted fw-normal mt-0 mb-2">Aprobados</h5>
                            <h3 class="my-2 text-success" id="parametrosAprobados">{{ parametros_aprobados }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle text-success fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card card-hover border-danger">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="text-muted fw-normal mt-0 mb-2">Rechazados</h5>
                            <h3 class="my-2 text-danger" id="parametrosRechazados">{{ parametros_rechazados }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-times-circle text-danger fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card card-hover border-info text-white" style="background-color: #17a2b8;">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="fw-normal mt-0 mb-2">% Aprobación</h5>
                            <h2 class="my-2" id="porcentajeAprobacion">{{ porcentaje_aprobacion }}%</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-pie fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para concluir prueba -->
<div class="modal fade" id="modalConcluirPrueba" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-flag-checkered me-2"></i>
                    Concluir Prueba Química
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="#" id="formConcluirPrueba">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-chart-pie me-2"></i> Resumen de Resultados</h6>
                        <div class="row mt-2">
                            <div class="col-md-4 text-center">
                                <div class="h4" id="modalTotalParametros">{{ total_parametros }}</div>
                                <small class="text-muted">Total Parámetros</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="h4 text-success" id="modalAprobados">{{ parametros_aprobados }}</div>
                                <small class="text-muted">Aprobados</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="h4" id="modalPorcentaje">{{ porcentaje_aprobacion }}%</div>
                                <small class="text-muted">% Aprobación</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="resultadoFinal" class="form-label">Resultado Final</label>
                        <textarea class="form-control" id="resultadoFinal" name="resultado_final" 
                                  rows="4" placeholder="Describa el resultado final de la prueba..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacionesFinal" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observacionesFinal" name="observaciones" 
                                  rows="3" placeholder="Observaciones adicionales..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Decisión Final</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="aprobado" id="aprobadoSi" value="true">
                            <label class="form-check-label text-success" for="aprobadoSi">
                                <i class="fas fa-thumbs-up me-2"></i> Aprobar Prueba
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="aprobado" id="aprobadoNo" value="false">
                            <label class="form-check-label text-danger" for="aprobadoNo">
                                <i class="fas fa-thumbs-down me-2"></i> Rechazar Prueba
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar Conclusión</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para detalles del parámetro -->
<div class="modal fade" id="modalDetalleParametro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-vial me-2"></i>
                    <span id="modalParametroNombre"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-4">Valor Medido:</dt>
                    <dd class="col-sm-8" id="modalParametroValor"></dd>
                    
                    <dt class="col-sm-4">Rango Permitido:</dt>
                    <dd class="col-sm-8" id="modalParametroRango"></dd>
                    
                    <dt class="col-sm-4">Unidad:</dt>
                    <dd class="col-sm-8" id="modalParametroUnidad"></dd>
                    
                    <dt class="col-sm-4">Estado:</dt>
                    <dd class="col-sm-8">
                        <span class="badge" id="modalParametroEstado"></span>
                    </dd>
                    
                    <dt class="col-sm-4">Observaciones:</dt>
                    <dd class="col-sm-8" id="modalParametroObservaciones"></dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Template para nuevos parámetros dinámicos -->
<template id="templateParametroDinamico">
    <div class="parametro-dinamico card mb-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-5">
                    <select class="form-control form-control-sm parametro-select" required>
                        <option value="">Seleccionar parámetro...</option>
                        {% for parametro in parametros_disponibles %}
                        <option value="{{ parametro.id }}" 
                                data-min="{{ parametro.valor_minimo|default:'' }}"
                                data-max="{{ parametro.valor_maximo|default:'' }}"
                                data-unidad="{{ parametro.unidad_medida|default:'' }}">
                            {{ parametro.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm valor-input" 
                           placeholder="Valor medido" required>
                    <small class="form-text text-muted unidad-text"></small>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm observacion-input" 
                           placeholder="Observación">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-danger btn-eliminar-dinamico">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block javascript %}
<script>
$(document).ready(function() {
    // ============================================
    // FUNCIÓN PARA CONSTRUIR URLs CON UUIDs
    // ============================================
    
    // URLs directas usando las variables de template
    const URLS = {
        agregarParametros: '{% url "agregar_parametros_prueba" prueba.id %}',
        calcularResultados: '{% url "calcular_resultados_prueba" prueba.id %}',
        
        // Para los parámetros, construiremos dinámicamente
    };
    
    // Función para construir URL de edición con UUID
    function getEditarUrl(parametroId) {
        // Si ya tienes la URL en el template, úsala así:
        return `/produccion/parametro-prueba/${parametroId}/editar/`;
    }
    
    function getEliminarUrl(parametroId) {
        return `/produccion/parametro-prueba/${parametroId}/eliminar/`;
    }
    
    function getEstadoUrl(estado) {
        return `/produccion/prueba-quimica/{{ prueba.id }}/estado/${estado}/`;
    }
    
    // ============================================
    // 1. CONFIGURACIÓN INICIAL
    // ============================================
    
    // Variables globales
    let contadorParametros = {{ total_parametros }};
    let contadorAprobados = {{ parametros_aprobados }};
    let contadorRechazados = {{ parametros_rechazados }};
    
    // Obtener token CSRF de forma segura
    function getCSRFToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }
    
    // ============================================
    // 2. FUNCIONALIDAD PARA EDITAR PARÁMETROS
    // ============================================
    
    // Editar parámetro
    $(document).on('click', '.btn-editar', function() {
        const parametroId = $(this).data('id');  // Este es un UUID
        const $fila = $(`#parametro-${parametroId}`);
        
        // Cambiar a modo edición
        $fila.find('.valor-actual').addClass('d-none');
        $fila.find('.valor-edit').removeClass('d-none');
        $(this).addClass('d-none');
        $fila.find('.btn-guardar, .btn-cancelar').removeClass('d-none');
    });
    
    // Cancelar edición
    $(document).on('click', '.btn-cancelar', function() {
        const parametroId = $(this).data('id');
        const $fila = $(`#parametro-${parametroId}`);
        
        // Cancelar edición
        $fila.find('.valor-edit').addClass('d-none');
        $fila.find('.valor-actual').removeClass('d-none');
        $fila.find('.btn-editar').removeClass('d-none');
        $fila.find('.btn-guardar, .btn-cancelar').addClass('d-none');
    });
    
    // Guardar cambios (con UUID)
    $(document).on('click', '.btn-guardar', function() {
        const $btn = $(this);
        const parametroId = $btn.data('id');  // UUID del parámetro
        const $fila = $(`#parametro-${parametroId}`);
        const nuevoValor = $fila.find('.valor-edit').val().trim();
        
        if (!nuevoValor) {
            mostrarMensaje('warning', 'Ingrese un valor para el parámetro');
            return;
        }
        
        // 1. Usar jQuery.ajax que maneja mejor CSRF
    $.ajax({
        url: `/produccion/parametro-prueba/${parametroId}/editar/`,
        method: 'POST',
        dataType: 'json',
        data: {
            'valor_medido': nuevoValor,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        beforeSend: function(xhr) {
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            console.log('Enviando a:', this.url);
        },
        success: function(data) {
            console.log('Respuesta:', data);
            
            if (data.success) {
                $fila.find('.valor-actual').text(nuevoValor);
                $fila.find('.valor-actual').removeClass('d-none');
                $fila.find('.valor-edit').addClass('d-none');
                
                if (data.dentro_especificacion) {
                    $fila.removeClass('table-danger').addClass('table-success');
                    $fila.find('.estado-badge')
                        .removeClass('bg-danger')
                        .addClass('bg-success')
                        .html('<i class="fas fa-check me-1"></i> OK');
                } else {
                    $fila.removeClass('table-success').addClass('table-danger');
                    $fila.find('.estado-badge')
                        .removeClass('bg-success')
                        .addClass('bg-danger')
                        .html('<i class="fas fa-times me-1"></i> Falla');
                }
                
                alert('¡Actualizado correctamente!');
            } else {
                alert('Error: ' + data.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('AJAX Error:', status, error);
            console.error('Response:', xhr.responseText);
            alert(`Error ${xhr.status}: ${error}\n\nDetalles en consola.`);
        },
  

      complete: function() {
            $fila.find('.btn-editar').removeClass('d-none');
            $fila.find('.btn-guardar, .btn-cancelar').addClass('d-none');
            $btn.prop('disabled', false).html('<i class="fas fa-save"></i>');
        }
    });
});

    // ============================================
    // 3. ELIMINAR PARÁMETROS (con UUID)
    // ============================================
    
    $(document).on('click', '.btn-eliminar', function() {
        const $btn = $(this);
        const parametroId = $btn.data('id');  // UUID del parámetro
        const nombreParametro = $btn.data('nombre');
        
        // Confirmación
        if (!confirm(`¿Está seguro de eliminar el parámetro "${nombreParametro}"?`)) {
            return;
        }
        
        $btn.prop('disabled', true);
        
        // Configurar datos para enviar
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', getCSRFToken());
        
        // Hacer petición AJAX con UUID
        fetch(getEliminarUrl(parametroId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Determinar estado para ajustar contadores
                const $fila = $(`#parametro-${parametroId}`);
                const eraAprobado = $fila.hasClass('table-success');
                
                // Ajustar contadores
                if (eraAprobado) {
                    contadorAprobados = Math.max(0, contadorAprobados - 1);
                } else {
                    contadorRechazados = Math.max(0, contadorRechazados - 1);
                }
                contadorParametros = Math.max(0, contadorParametros - 1);
                
                // Eliminar fila
                $fila.remove();
                
                // Actualizar contadores en la UI
                actualizarContadores();
                
                // Mostrar mensaje
                mostrarMensaje('success', 'Parámetro eliminado correctamente');
                
                // Si no quedan parámetros, mostrar mensaje
                if ($('#tablaParametros tr').not('#sinParametros').length === 0) {
                    if (!$('#sinParametros').length) {
                        $('#tablaParametros').append(`
                            <tr id="sinParametros">
                                <td colspan="7" class="text-center py-4">
                                    <i class="fas fa-flask fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No hay parámetros registrados</h5>
                                    <p class="text-muted mb-0">Agregue parámetros para evaluar esta prueba</p>
                                </td>
                            </tr>
                        `);
                    }
                    $('#sinParametros').show();
                }
            } else {
                mostrarMensaje('error', 'Error: ' + (data.message || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error en la petición:', error);
            mostrarMensaje('error', 'Error al eliminar el parámetro');
        })
        .finally(() => {
            $btn.prop('disabled', false);
        });
    });
    
    // ============================================
    // 4. AGREGAR NUEVOS PARÁMETROS (con UUID de prueba)
    // ============================================
    
    $('#btnAgregarParametro, #btnAgregarParametroModal').on('click', function() {
        $('#nuevosParametrosContainer').toggle();
        if ($('#nuevosParametrosContainer').is(':visible')) {
            agregarCampoParametro();
        }
    });
    
    function agregarCampoParametro() {
        const template = document.getElementById('templateParametroDinamico');
        const clone = template.content.cloneNode(true);
        
        const $clone = $(clone);
        
        // Configurar eventos
        $clone.find('.parametro-select').on('change', function() {
            const unidad = $(this).find('option:selected').data('unidad') || '';
            $(this).closest('.parametro-dinamico').find('.unidad-text').text('Unidad: ' + unidad);
        });
        
        $clone.find('.btn-eliminar-dinamico').on('click', function() {
            $(this).closest('.parametro-dinamico').remove();
        });
        
        $('#parametrosDinamicos').append($clone);
    }
    
    $('#btnAgregarMas').on('click', agregarCampoParametro);
    
    // Guardar nuevos parámetros
    $('#formAgregarParametros').on('submit', function(e) {
        e.preventDefault();
        
        const parametrosData = [];
        let valido = true;
        
        // Validar y recopilar datos
        $('.parametro-dinamico').each(function() {
            const $select = $(this).find('.parametro-select');
            const $valor = $(this).find('.valor-input');
            const $observacion = $(this).find('.observacion-input');
            
            if (!$select.val() || !$valor.val().trim()) {
                valido = false;
                $(this).addClass('border-danger');
                return false;
            }
            
            $(this).removeClass('border-danger');
            
            parametrosData.push({
                parametro_id: $select.val(),
                valor_medido: $valor.val().trim(),
                observaciones: $observacion.val().trim(),
                parametro_nombre: $select.find('option:selected').text()
            });
        });
        
        if (!valido) {
            mostrarMensaje('warning', 'Complete todos los campos requeridos (marcados en rojo)');
            return;
        }
        
        if (parametrosData.length === 0) {
            mostrarMensaje('warning', 'Agregue al menos un parámetro');
            return;
        }
        
        // Configurar botón de envío
        const $submitBtn = $('#formAgregarParametros button[type="submit"]');
        $submitBtn.prop('disabled', true)
            .html('<i class="fas fa-spinner fa-spin me-1"></i> Guardando...');
        
        // Enviar datos al servidor
        fetch(URLS.agregarParametros, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                parametros: parametrosData,
                csrfmiddlewaretoken: getCSRFToken()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarMensaje('success', data.message || 'Parámetros agregados correctamente');
                
                // Recargar la página después de un breve retraso
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                mostrarMensaje('error', data.message || 'Error al guardar los parámetros');
                $submitBtn.prop('disabled', false)
                    .html('<i class="fas fa-save me-1"></i> Guardar Todos');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarMensaje('error', 'Error de conexión al servidor');
            $submitBtn.prop('disabled', false)
                .html('<i class="fas fa-save me-1"></i> Guardar Todos');
        });
    });
    
    // ============================================
    // 5. CALCULAR RESULTADOS
    // ============================================
    
    $('#btnCalcularResultados').on('click', function() {
        const $btn = $(this);
        $btn.prop('disabled', true)
            .html('<i class="fas fa-spinner fa-spin me-1"></i> Calculando...');
        
        fetch(URLS.calcularResultados, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams({
                'csrfmiddlewaretoken': getCSRFToken()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar contadores globales
                contadorAprobados = data.aprobados;
                contadorRechazados = data.rechazados;
                actualizarContadores();
                
                // Actualizar cada parámetro en la tabla
                data.parametros.forEach(parametro => {
                    const $fila = $(`#parametro-${parametro.id}`);
                    if ($fila.length) {
                        if (parametro.dentro_especificacion) {
                            $fila.removeClass('table-danger').addClass('table-success');
                            $fila.find('.estado-badge')
                                .removeClass('bg-danger')
                                .addClass('bg-success')
                                .html('<i class="fas fa-check me-1"></i> OK');
                        } else {
                            $fila.removeClass('table-success').addClass('table-danger');
                            $fila.find('.estado-badge')
                                .removeClass('bg-success')
                                .addClass('bg-danger')
                                .html('<i class="fas fa-times me-1"></i> Falla');
                        }
                    }
                });
                
                mostrarMensaje('success', 'Resultados calculados correctamente');
            } else {
                mostrarMensaje('error', data.message || 'Error al calcular resultados');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarMensaje('error', 'Error de conexión al servidor');
        })
        .finally(() => {
            $btn.prop('disabled', false)
                .html('<i class="fas fa-calculator me-1"></i> Calcular Resultados');
        });
    });
    
    // ============================================
    // 6. FUNCIONES AUXILIARES
    // ============================================
    
    function actualizarContadores() {
        const total = contadorParametros;
        const aprobados = contadorAprobados;
        const rechazados = contadorRechazados;
        const porcentaje = total > 0 ? Math.round((aprobados / total) * 100) : 0;
        
        // Actualizar tarjetas de resumen
        $('#totalParametros').text(total);
        $('#parametrosAprobados').text(aprobados);
        $('#parametrosRechazados').text(rechazados);
        $('#porcentajeAprobacion').text(porcentaje + '%');
        
        // Actualizar contadores en la tabla
        $('#contadorTotal').text(total);
        $('#contadorAprobados').text(aprobados);
        $('#contadorTotalFooter').text(total);
        
        // Actualizar modal de conclusión
        $('#modalTotalParametros').text(total);
        $('#modalAprobados').text(aprobados);
        $('#modalPorcentaje').text(porcentaje + '%');
        
        // Actualizar gráfico si existe
        if (window.graficoPrueba && window.graficoPrueba.data) {
            window.graficoPrueba.data.datasets[0].data = [aprobados, rechazados];
            window.graficoPrueba.update();
        }
    }
    
    function mostrarMensaje(tipo, mensaje) {
        // Eliminar mensajes anteriores
        $('.alert-flotante').remove();
        
        const iconos = {
            'success': 'check-circle',
            'error': 'exclamation-circle',
            'warning': 'exclamation-triangle',
            'info': 'info-circle'
        };
        
        const $alert = $(`
            <div class="alert alert-${tipo} alert-dismissible fade show alert-flotante" 
                 style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas fa-${iconos[tipo] || 'info-circle'} me-2"></i>
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append($alert);
        
        // Auto-eliminar después de 5 segundos
        setTimeout(() => {
            $alert.alert('close');
        }, 5000);
    }
    
    // ============================================
    // 7. INICIALIZACIÓN DE GRÁFICO
    // ============================================
    
    {% if total_parametros > 0 %}
    const ctx = document.getElementById('graficoPrueba').getContext('2d');
    window.graficoPrueba = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Aprobados', 'Rechazados'],
            datasets: [{
                data: [{{ parametros_aprobados }}, {{ parametros_rechazados }}],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                borderColor: [
                    'rgb(40, 167, 69)',
                    'rgb(220, 53, 69)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            const value = context.raw;
                            const total = {{ total_parametros }};
                            const percentage = Math.round((value / total) * 100);
                            return `${label}${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
    
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}