<!-- templates/produccion/crear_produccion.html -->
{% extends "base/base.html" %}
{% load static %}

{% block contenido %} <!---->
<div class="wrapper">
    <div class="content-page">
        <div class="container-fluid">
            <div class="container mt-4">
                <div class="form-container">
                    <h1>Registro de Nueva Producción</h1>
        
                    <!-- Indicadores de pasos -->
                    <div class="step-indicators">
                        <div class="step-indicator active" data-step="1">Datos de Producción</div>
                        <div class="step-indicator" data-step="2">Materias Primas</div>
                    </div>

                    <!-- Paso 1: Datos de producción -->
                    <div class="step active" id="step1">
                        <h2>Datos de la Producción</h2>
                        <form id="produccionForm">
                        {% csrf_token %}

                        {% if produccion_base %}
                        <div class="alert alert-warning">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-recycle fa-2x me-3"></i>
                                <div>
                                    <h5 class="mb-1">
                                        <i class="fas fa-info-circle"></i> 
                                        Reutilizando producción: {{ produccion_base.lote }}
                                    </h5>
                                    <p class="mb-0">
                                        <strong>Producto:</strong> {{ produccion_base.catalogo_producto.nombre_comercial }} |
                                        <strong>Cantidad:</strong> {{ produccion_base.cantidad_estimada|floatformat:2 }}L |
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Campo oculto para producción base -->
                        <input type="hidden" name="produccion_base" value="{{ produccion_base.id }}">
                        <input type="hidden" name="observaciones_reutilizacion" value="Reutilizando {{ produccion_base.lote }}">
                        {% endif %}

            
                        <div class="form-row">                        
                            <!-- Selección de producto -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Selección del Producto</h5>
                                </div>
                                <div class="card-body">
                                    <!-- Opción 1: Producto existente -->
                                    <div class="mb-3">
                                        <label for="{{ produccion_form.catalogo_producto.id_for_label }}" class="form-label">
                                            {{ produccion_form.catalogo_producto.label }}
                                        </label>
                                        {{ produccion_form.catalogo_producto }}
                                        {% if produccion_form.catalogo_producto.errors %}
                                            <div class="text-danger small">{{ produccion_form.catalogo_producto.errors }}</div>
                                        {% endif %}
                                        <div class="form-text">{{ produccion_form.catalogo_producto.help_text }}</div>
                                    </div>

                                    <div class="text-center my-3">
                                        <strong class="text-muted">- O -</strong>
                                    </div>

                                    <!-- Opción 2: Nuevo producto -->
                                    <div class="border-start border-3 border-primary ps-3">
                                        <div class="mb-3">
                                            <label for="{{ produccion_form.nuevo_producto_nombre.id_for_label }}" class="form-label">
                                                {{ produccion_form.nuevo_producto_nombre.label }}
                                            </label>
                                            {{ produccion_form.nuevo_producto_nombre }}
                                            {% if produccion_form.nuevo_producto_nombre.errors %}
                                                <div class="text-danger small">{{ produccion_form.nuevo_producto_nombre.errors }}</div>
                                            {% endif %}
                                            <div class="form-text">{{ produccion_form.nuevo_producto_nombre.help_text }}</div>
                                        </div>
                                    </div>  
                                </div>
                            </div>  
                            <div class="col-md-3 mb-3">
                                {{ produccion_form.prod_result.label_tag }}
                                {{ produccion_form.prod_result }}
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-3 mb-3">
                                {{ produccion_form.cantidad_estimada.label_tag }}
                                {{ produccion_form.cantidad_estimada }}
                            </div>
                            <!--<div class="col-md-3 mb-3">
                                {{ produccion_form.costo.label_tag }}
                                {{ produccion_form.costo }}
                            </div>-->
                            <div class="col-md-6 mb-3">
                                {{ produccion_form.planta.label_tag }}
                                {{ produccion_form.planta }}
                            </div>
                        </div>
                        </form>
                        <div class="navigation-buttons">
                            <button type="button" class="btn-secondary" disabled>Anterior</button>
                            <button type="button" class="btn-primary" onclick="nextStep(2)">Siguiente</button>
                        </div>
                    </div>

                    <!-- Paso 2: Materias primas -->
                    <div class="step" id="step2">
                        <h2>Materias Primas Necesarias</h2>
                        <button type="button" class="add-btn" onclick="agregarMateriaPrima()">
                            + Agregar Materia Prima
                        </button>
                        <div id="materiasPrimasContainer">
                            <!-- Las materias primas se agregarán aquí dinámicamente -->
                        </div>
                        <div class="navigation-buttons">
                            <button type="button" class="btn-secondary" onclick="prevStep(1)">Anterior</button>
                            <button type="button" class="add-btn" onclick="agregarMateriaPrima()">+ Agregar Materia Prima</button>
                            <button type="button" class="btn-primary" onclick="enviarProduccion()">Finalizar Planificación</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para materia prima (hidden) -->
<template id="materiaPrimaTemplate">
    <div class="materia-prima-item">
        <h4>Materia Prima #<span class="item-number"></span></h4>
        <div class="form-group">
            <label>Materia Prima - Almacen:</label>
            <select class="materia-prima-select" name="materia_prima" required>
                <option value="">Seleccionar materia prima...</option>
                {% for mp in materia_prima_form.fields.materia_prima.queryset %}
                <option value="{{ mp.id }}" data-costo="{{ mp.costo }}" data-unidad="{{ mp.unidad_medida }}">
                    {{ mp.materia_prima.nombre }}({{ mp.materia_prima.conformacion }}-{{ mp.materia_prima.unidad_medida }}) - {{ mp.almacen}}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label>Cantidad:</label>
            <input type="number" class="cantidad-input" name="cantidad" step="0.001" required>
            <span class="unidad-text"></span>
        </div>
        
        <!--<div class="form-group">
            <label>Almacén:</label>
            <select class="almacen-select" name="almacen" required>
                <option value="">Seleccionar almacén...</option>
                {% for almacen in materia_prima_form.fields.almacen.queryset %}
                <option value="{{ almacen.id }}">{{ almacen.nombre }}</option>
                {% endfor %}
            </select>
        </div>-->
        
        <div class="form-group">
            <label>Costo estimado:</label>
            <span class="costo-text">$0.00</span>
        </div>
        
        <button type="button" class="remove-btn" onclick="removerMateriaPrima(this)">Eliminar</button>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Alternar entre producto existente y nuevo
    const productoExistente = document.getElementById('{{ form.catalogo_producto.id_for_label }}');
    const nuevoProductoNombre = document.getElementById('{{ form.nuevo_producto_nombre.id_for_label }}');
    
    function toggleCamposProducto() {
        const nuevoProductoSection = nuevoProductoNombre.closest('.border-start');
        
        if (productoExistente.value) {
            // Si hay producto seleccionado, deshabilitar campos de nuevo producto
            nuevoProductoNombre.value = '';
            nuevoProductoNombre.disabled = true;
            nuevoProductoSection.style.opacity = '0.6';
        } else if (nuevoProductoNombre.value) {
            // Si hay nombre de nuevo producto, deshabilitar selección existente
            productoExistente.value = '';
            productoExistente.disabled = true;
        } else {
            // Si ambos están vacíos, habilitar ambos
            nuevoProductoNombre.disabled = false;
            productoExistente.disabled = false;
            nuevoProductoSection.style.opacity = '1';
        }
    }
    
    productoExistente.addEventListener('change', toggleCamposProducto);
    nuevoProductoNombre.addEventListener('input', toggleCamposProducto);
    
    // Inicializar estado
    toggleCamposProducto();
});
</script>

<script>
// Datos de materias primas desde Django
const materiasPrimasData = {{ materias_primas_json|safe }};
var materiaPrimaCount = 0;

function nextStep(step) {
    if (step === 2 && !validarPaso1()) {
        alert('Por favor, complete todos los campos requeridos del paso 1.');
        return;
    }
    
    document.querySelector('.step.active').classList.remove('active');
    document.querySelector('.step-indicator.active').classList.remove('active');
    
    document.getElementById(`step${step}`).classList.add('active');
    document.querySelector(`.step-indicator[data-step="${step}"]`).classList.add('active');
}

function prevStep(step) {
    document.querySelector('.step.active').classList.remove('active');
    document.querySelector('.step-indicator.active').classList.remove('active');
    
    document.getElementById(`step${step}`).classList.add('active');
    document.querySelector(`.step-indicator[data-step="${step}"]`).classList.add('active');
}

function validarPaso1() {
    const requiredFields = document.querySelectorAll('#step1 input[required], #step1 select[required]');
    
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            field.focus();
            return false;
        }
    }
    return true;
}

function agregarMateriaPrima() {
    materiaPrimaCount++;
    
    const template = document.getElementById('materiaPrimaTemplate');
    const clone = template.content.cloneNode(true);
    const materiaPrimaDiv = clone.querySelector('.materia-prima-item');
    
    materiaPrimaDiv.id = `materia-prima-${materiaPrimaCount}`;
    materiaPrimaDiv.querySelector('.item-number').textContent = materiaPrimaCount;

    /*const elemento = materiaPrimaDiv.querySelector('.item-number');
    const valor = materiaPrimaCount;

    if (!isNaN(valor) && valor !== null && valor !== undefined) {
        elemento.textContent = valor+1;
    } else {
        elemento.textContent = '0'; // o 'N/A', o ''
    }*/
    
    // Agregar event listeners
    const select = materiaPrimaDiv.querySelector('.materia-prima-select');
    const cantidadInput = materiaPrimaDiv.querySelector('.cantidad-input');
    
    select.addEventListener('change', function() {
        actualizarInfoMateriaPrima(this);
    });
    
    cantidadInput.addEventListener('input', function() {
        calcularCostoMateriaPrima(this.closest('.materia-prima-item'));
    });
    
    document.getElementById('materiasPrimasContainer').appendChild(materiaPrimaDiv);
}

function removerMateriaPrima(button) {
    button.closest('.materia-prima-item').remove();
}

function actualizarInfoMateriaPrima(select) {
    const item = select.closest('.materia-prima-item');
    const selectedOption = select.options[select.selectedIndex];
    const unidadSpan = item.querySelector('.unidad-text');
    
    if (selectedOption.value) {
        const unidad = selectedOption.getAttribute('data-unidad');
        unidadSpan.textContent = unidad;
    } else {
        unidadSpan.textContent = '';
    }
    
    calcularCostoMateriaPrima(item);
}

function calcularCostoMateriaPrima(item) {
    const select = item.querySelector('.materia-prima-select');
    const cantidadInput = item.querySelector('.cantidad-input');
    const costoSpan = item.querySelector('.costo-text');
    
    const selectedOption = select.options[select.selectedIndex];
    const cantidad = parseFloat(cantidadInput.value) || 0;
    const costoUnitario = parseFloat(selectedOption.getAttribute('data-costo')) || 0;
    
    const costoTotal = cantidad * costoUnitario;
    costoSpan.textContent = `$${costoTotal.toFixed(2)}`;
}

function enviarProduccion() {
    const items = document.querySelectorAll('.materia-prima-item');
    
    if (items.length === 0) {
        alert('Debe agregar al menos una materia prima.');
        return;
    }
    
    if (!validarMateriasPrimas()) {
        alert('Por favor, complete todos los campos de las materias primas.');
        return;
    }
    
    // Validar también el paso 1
    if (!validarPaso1()) {
        alert('Por favor, complete todos los campos del paso 1.');
        prevStep(1);
        return;
    }
    
    // Primero guardar el paso 1 si no está guardado
    guardarPaso1().then(() => {
        // Luego enviar el paso 2
        enviarPaso2(items);
    }).catch(error => {
        console.error('Error al guardar paso 1:', error);
        alert('Error al guardar los datos de producción');
    });
}

function guardarPaso1() {
    return new Promise((resolve, reject) => {
        const produccionForm = document.getElementById('produccionForm');
        const formData = new FormData(produccionForm);
        formData.append('step', '1');
        
        fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resolve(data);
            } else {
                reject(data.errors);
            }
        })
        .catch(error => reject(error));
    });
}

function enviarPaso2(items) {
    const formData = new FormData();
    formData.append('step', '2');
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    // Agregar datos de materias primas
    items.forEach((item, index) => {
        const materiaPrima = item.querySelector('.materia-prima-select').value;
        const cantidad = item.querySelector('.cantidad-input').value;
        //const almacen = item.querySelector('.almacen-select').value;
        
        formData.append(`materias_primas[${index}][materia_prima]`, materiaPrima);
        formData.append(`materias_primas[${index}][cantidad]`, cantidad);
        //formData.append(`materias_primas[${index}][almacen]`, almacen);
    });
    
    // Mostrar loading
    const submitBtn = document.querySelector('#step2 .btn-primary');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Guardando...';
    submitBtn.disabled = true;
    
    // Enviar datos al servidor
    fetch('', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            }
        } else {
            alert('Error: ' + JSON.stringify(data.errors));
            // Si el error es por datos de producción perdidos, volver al paso 1
            if (data.errors && data.errors.includes('no encontrados')) {
                prevStep(1);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Cantidad de materia prima insuficiente en almacén. Verifique disponibilidad');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

function validarMateriasPrimas() {
    const items = document.querySelectorAll('.materia-prima-item');
    
    for (let item of items) {
        const materiaPrima = item.querySelector('.materia-prima-select').value;
        const cantidad = item.querySelector('.cantidad-input').value;
        //const almacen = item.querySelector('.almacen-select').value;
        
        if (!materiaPrima || !cantidad ) {
            return false;
        }
    }
    return true;
}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-completar formulario si hay datos pre-cargados
        const urlParams = new URLSearchParams(window.location.search);
        const produccionBaseId = urlParams.get('produccion_base_id');
        
        if (produccionBaseId) {
            // Auto-seleccionar planta si viene en URL
            const plantaId = urlParams.get('planta_id');
            if (plantaId && document.getElementById('id_planta')) {
                document.getElementById('id_planta').value = plantaId;
            }
            
            // Auto-seleccionar producto
            const productoId = urlParams.get('catalogo_producto_id');
            if (productoId && document.getElementById('id_catalogo_producto')) {
                document.getElementById('id_catalogo_producto').value = productoId;
            }
            
            // Auto-completar cantidad
            const cantidad = urlParams.get('cantidad_estimada');
            if (cantidad && document.getElementById('id_cantidad_estimada')) {
                document.getElementById('id_cantidad_estimada').value = cantidad;
            }
            
            // Auto-marcar producto base si corresponde
            const prodResult = urlParams.get('prod_result');
            if (prodResult === 'on' && document.getElementById('id_prod_result')) {
                document.getElementById('id_prod_result').checked = true;
            }
        }
        
        // Mostrar materias primas pre-cargadas como sugerencia
        const materiasPrecargadas = {{ materias_primas_precargadas|safe|default:"[]" }};
        if (materiasPrecargadas.length > 0) {
            mostrarMateriasPrimasSugeridas(materiasPrecargadas);
        }
    });
    
    function mostrarMateriasPrimasSugeridas(materias) {
        // Crear un contenedor para las sugerencias
        const container = document.createElement('div');
        container.className = 'card mt-3';
        container.innerHTML = `
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Materias Primas Sugeridas (de la producción base)
                </h6>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Estas son las materias primas utilizadas en la producción base.
                    Puede usarlas como referencia o hacer clic para agregarlas automáticamente.
                </p>
                <div id="materias-sugeridas-list"></div>
                <button type="button" class="btn btn-sm btn-outline-info mt-2" 
                        onclick="agregarTodasMateriasSugeridas()">
                    <i class="fas fa-plus-circle me-1"></i>Agregar Todas
                </button>
            </div>
        `;
        
        // Insertar después del formulario de materias primas
        const formMaterias = document.querySelector('.card.mb-4');
        if (formMaterias) {
            formMaterias.parentNode.insertBefore(container, formMaterias.nextSibling);
        }
        
        // Llenar la lista
        const listContainer = document.getElementById('materias-sugeridas-list');
        materias.forEach((mp, index) => {
            const item = document.createElement('div');
            item.className = 'd-flex justify-content-between align-items-center border-bottom py-2';
            item.innerHTML = `
                <div>
                    <strong>${mp.materia_prima_nombre}</strong>
                    <br>
                    <small class="text-muted">
                        ${mp.cantidad} ${mp.unidad_medida} • 
                        Almacén: ${mp.almacen_nombre} • 
                        Costo: $${mp.costo}
                    </small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-success" 
                        onclick="agregarMateriaSugerida(${index})">
                    <i class="fas fa-plus"></i> Agregar
                </button>
            `;
            listContainer.appendChild(item);
            
            // Guardar en data attribute para uso posterior
            item.setAttribute('data-materia-data', JSON.stringify(mp));
        });
    }
    
    function agregarMateriaSugerida(index) {
        // Obtener datos de la materia prima
        const items = document.querySelectorAll('#materias-sugeridas-list > div');
        const item = items[index];
        const mpData = JSON.parse(item.getAttribute('data-materia-data'));
        
        // Llamar a la función que agrega materias primas (debes tenerla en tu JS)
        if (typeof agregarMateriaPrima === 'function') {
            agregarMateriaPrima({
                materia_prima: mpData.materia_prima_id,
                cantidad: mpData.cantidad,
                almacen: mpData.almacen_id
            });
            
            // Cambiar botón a agregado
            const btn = item.querySelector('button');
            btn.innerHTML = '<i class="fas fa-check"></i> Agregada';
            btn.className = 'btn btn-sm btn-success';
            btn.disabled = true;
        }
    }
    
    function agregarTodasMateriasSugeridas() {
        const items = document.querySelectorAll('#materias-sugeridas-list > div');
        items.forEach((item, index) => {
            const btn = item.querySelector('button');
            if (!btn.disabled) {
                agregarMateriaSugerida(index);
            }
        });
    }
</script>

<style>
/* Los mismos estilos CSS que en el ejemplo anterior */
.form-container { max-width: 800px; margin: 0 auto; padding: 20px; }
.step { display: none; }
.step.active { display: block; }
.form-group { margin-bottom: 15px; }
label { display: block; margin-bottom: 5px; font-weight: bold; }
input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
.navigation-buttons { margin-top: 20px; display: flex; justify-content: space-between; }
button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
.btn-primary { background-color: #007bff; color: white; }
.btn-secondary { background-color: #6c757d; color: white; }
.materia-prima-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 4px; }
.remove-btn { background-color: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; }
.add-btn { background-color: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 3px; cursor: pointer; margin-bottom: 15px; }
.step-indicators { display: flex; margin-bottom: 20px; }
.step-indicator { flex: 1; text-align: center; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; }
.step-indicator.active { background: #007bff; color: white; }
</style>
{% endblock %}